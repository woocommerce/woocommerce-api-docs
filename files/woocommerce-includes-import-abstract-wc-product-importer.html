<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WooCommerce Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1626085995">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1626085995">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.svg" alt="WooCommerce" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.woocommerce.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">WooCommerce Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="../namespaces/automattic-woocommerce.html"><abbr title="\Automattic\WooCommerce">WooCommerce</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerce.html"><abbr title="\WooCommerce">WooCommerce</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerce-Classes.html"><abbr title="\WooCommerce\Classes">Classes</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Abstracts.html"><abbr title="\WooCommerce\Abstracts">Abstracts</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Admin.html"><abbr title="\WooCommerce\Admin">Admin</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Views.html"><abbr title="\WooCommerce\Views">Views</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Helper.html"><abbr title="\WooCommerce\Helper">Helper</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Templates.html"><abbr title="\WooCommerce\Templates">Templates</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Reports.html"><abbr title="\WooCommerce\Reports">Reports</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Blocks.html"><abbr title="\WooCommerce\Blocks">Blocks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-RestApi.html"><abbr title="\WooCommerce\RestApi">RestApi</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-CLI.html"><abbr title="\WooCommerce\CLI">CLI</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-l10n.html"><abbr title="\WooCommerce\l10n">l10n</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Webhooks.html"><abbr title="\WooCommerce\Webhooks">Webhooks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-DataStores.html"><abbr title="\WooCommerce\DataStores">DataStores</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Emails.html"><abbr title="\WooCommerce\Emails">Emails</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Export.html"><abbr title="\WooCommerce\Export">Export</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Gateways.html"><abbr title="\WooCommerce\Gateways">Gateways</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-PayPal.html"><abbr title="\WooCommerce\PayPal">PayPal</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Import.html"><abbr title="\WooCommerce\Import">Import</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Integrations.html"><abbr title="\WooCommerce\Integrations">Integrations</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Interfaces.html"><abbr title="\WooCommerce\Interfaces">Interfaces</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Interface.html"><abbr title="\WooCommerce\Interface">Interface</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-LogHandlers.html"><abbr title="\WooCommerce\LogHandlers">LogHandlers</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-PaymentTokens.html"><abbr title="\WooCommerce\PaymentTokens">PaymentTokens</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Utilities.html"><abbr title="\WooCommerce\Utilities">Utilities</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Shipping.html"><abbr title="\WooCommerce\Shipping">Shipping</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Shortcodes.html"><abbr title="\WooCommerce\Shortcodes">Shortcodes</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Tracks.html"><abbr title="\WooCommerce\Tracks">Tracks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Traits.html"><abbr title="\WooCommerce\Traits">Traits</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Functions.html"><abbr title="\WooCommerce\Functions">Functions</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-WCCom.html"><abbr title="\WooCommerce\WCCom">WCCom</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Widgets.html"><abbr title="\WooCommerce\Widgets">Widgets</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Uninstaller.html"><abbr title="\WooCommerce\Uninstaller">Uninstaller</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WoocommerceAdmin.html"><abbr title="\WoocommerceAdmin">WoocommerceAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WoocommerceNavigation.html"><abbr title="\WoocommerceNavigation">WoocommerceNavigation</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/Automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/Automattic-WooCommerce.html"><abbr title="\Automattic\WooCommerce">WooCommerce</abbr></a></li>
                            </ul>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">abstract-wc-product-importer.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * Abstract Product importer
 *
 * @package  WooCommerce\Import
 * @version  3.1.0
 */

use Automattic\WooCommerce\Utilities\NumberUtil;

if ( ! defined( &#039;ABSPATH&#039; ) ) {
	exit;
}

/**
 * Include dependencies.
 */
if ( ! class_exists( &#039;WC_Importer_Interface&#039;, false ) ) {
	include_once WC_ABSPATH . &#039;includes/interfaces/class-wc-importer-interface.php&#039;;
}

/**
 * WC_Product_Importer Class.
 */
abstract class WC_Product_Importer implements WC_Importer_Interface {

	/**
	 * CSV file.
	 *
	 * @var string
	 */
	protected $file = &#039;&#039;;

	/**
	 * The file position after the last read.
	 *
	 * @var int
	 */
	protected $file_position = 0;

	/**
	 * Importer parameters.
	 *
	 * @var array
	 */
	protected $params = array();

	/**
	 * Raw keys - CSV raw headers.
	 *
	 * @var array
	 */
	protected $raw_keys = array();

	/**
	 * Mapped keys - CSV headers.
	 *
	 * @var array
	 */
	protected $mapped_keys = array();

	/**
	 * Raw data.
	 *
	 * @var array
	 */
	protected $raw_data = array();

	/**
	 * Raw data.
	 *
	 * @var array
	 */
	protected $file_positions = array();

	/**
	 * Parsed data.
	 *
	 * @var array
	 */
	protected $parsed_data = array();

	/**
	 * Start time of current import.
	 *
	 * (default value: 0)
	 *
	 * @var int
	 */
	protected $start_time = 0;

	/**
	 * Get file raw headers.
	 *
	 * @return array
	 */
	public function get_raw_keys() {
		return $this-&gt;raw_keys;
	}

	/**
	 * Get file mapped headers.
	 *
	 * @return array
	 */
	public function get_mapped_keys() {
		return ! empty( $this-&gt;mapped_keys ) ? $this-&gt;mapped_keys : $this-&gt;raw_keys;
	}

	/**
	 * Get raw data.
	 *
	 * @return array
	 */
	public function get_raw_data() {
		return $this-&gt;raw_data;
	}

	/**
	 * Get parsed data.
	 *
	 * @return array
	 */
	public function get_parsed_data() {
		/**
		 * Filter product importer parsed data.
		 *
		 * @param array $parsed_data Parsed data.
		 * @param WC_Product_Importer $importer Importer instance.
		 */
		return apply_filters( &#039;woocommerce_product_importer_parsed_data&#039;, $this-&gt;parsed_data, $this );
	}

	/**
	 * Get importer parameters.
	 *
	 * @return array
	 */
	public function get_params() {
		return $this-&gt;params;
	}

	/**
	 * Get file pointer position from the last read.
	 *
	 * @return int
	 */
	public function get_file_position() {
		return $this-&gt;file_position;
	}

	/**
	 * Get file pointer position as a percentage of file size.
	 *
	 * @return int
	 */
	public function get_percent_complete() {
		$size = filesize( $this-&gt;file );
		if ( ! $size ) {
			return 0;
		}

		return absint( min( NumberUtil::round( ( $this-&gt;file_position / $size ) * 100 ), 100 ) );
	}

	/**
	 * Prepare a single product for create or update.
	 *
	 * @param  array $data     Item data.
	 * @return WC_Product|WP_Error
	 */
	protected function get_product_object( $data ) {
		$id = isset( $data[&#039;id&#039;] ) ? absint( $data[&#039;id&#039;] ) : 0;

		// Type is the most important part here because we need to be using the correct class and methods.
		if ( isset( $data[&#039;type&#039;] ) ) {

			if ( ! array_key_exists( $data[&#039;type&#039;], WC_Admin_Exporters::get_product_types() ) ) {
				return new WP_Error( &#039;woocommerce_product_importer_invalid_type&#039;, __( &#039;Invalid product type.&#039;, &#039;woocommerce&#039; ), array( &#039;status&#039; =&gt; 401 ) );
			}

			try {
				// Prevent getting &quot;variation_invalid_id&quot; error message from Variation Data Store.
				if ( &#039;variation&#039; === $data[&#039;type&#039;] ) {
					$id = wp_update_post(
						array(
							&#039;ID&#039;        =&gt; $id,
							&#039;post_type&#039; =&gt; &#039;product_variation&#039;,
						)
					);
				}

				$product = wc_get_product_object( $data[&#039;type&#039;], $id );
			} catch ( WC_Data_Exception $e ) {
				return new WP_Error( &#039;woocommerce_product_csv_importer_&#039; . $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( &#039;status&#039; =&gt; 401 ) );
			}
		} elseif ( ! empty( $data[&#039;id&#039;] ) ) {
			$product = wc_get_product( $id );

			if ( ! $product ) {
				return new WP_Error(
					&#039;woocommerce_product_csv_importer_invalid_id&#039;,
					/* translators: %d: product ID */
					sprintf( __( &#039;Invalid product ID %d.&#039;, &#039;woocommerce&#039; ), $id ),
					array(
						&#039;id&#039;     =&gt; $id,
						&#039;status&#039; =&gt; 401,
					)
				);
			}
		} else {
			$product = wc_get_product_object( &#039;simple&#039;, $id );
		}

		return apply_filters( &#039;woocommerce_product_import_get_product_object&#039;, $product, $data );
	}

	/**
	 * Process a single item and save.
	 *
	 * @throws Exception If item cannot be processed.
	 * @param  array $data Raw CSV data.
	 * @return array|WP_Error
	 */
	protected function process_item( $data ) {
		try {
			do_action( &#039;woocommerce_product_import_before_process_item&#039;, $data );
			$data = apply_filters( &#039;woocommerce_product_import_process_item_data&#039;, $data );

			// Get product ID from SKU if created during the importation.
			if ( empty( $data[&#039;id&#039;] ) &amp;&amp; ! empty( $data[&#039;sku&#039;] ) ) {
				$product_id = wc_get_product_id_by_sku( $data[&#039;sku&#039;] );

				if ( $product_id ) {
					$data[&#039;id&#039;] = $product_id;
				}
			}

			$object   = $this-&gt;get_product_object( $data );
			$updating = false;

			if ( is_wp_error( $object ) ) {
				return $object;
			}

			if ( $object-&gt;get_id() &amp;&amp; &#039;importing&#039; !== $object-&gt;get_status() ) {
				$updating = true;
			}

			if ( &#039;external&#039; === $object-&gt;get_type() ) {
				unset( $data[&#039;manage_stock&#039;], $data[&#039;stock_status&#039;], $data[&#039;backorders&#039;], $data[&#039;low_stock_amount&#039;] );
			}

			if ( &#039;variation&#039; === $object-&gt;get_type() ) {
				if ( isset( $data[&#039;status&#039;] ) &amp;&amp; -1 === $data[&#039;status&#039;] ) {
					$data[&#039;status&#039;] = 0; // Variations cannot be drafts - set to private.
				}
			}

			if ( &#039;importing&#039; === $object-&gt;get_status() ) {
				$object-&gt;set_status( &#039;publish&#039; );
				$object-&gt;set_slug( &#039;&#039; );
			}

			$result = $object-&gt;set_props( array_diff_key( $data, array_flip( array( &#039;meta_data&#039;, &#039;raw_image_id&#039;, &#039;raw_gallery_image_ids&#039;, &#039;raw_attributes&#039; ) ) ) );

			if ( is_wp_error( $result ) ) {
				throw new Exception( $result-&gt;get_error_message() );
			}

			if ( &#039;variation&#039; === $object-&gt;get_type() ) {
				$this-&gt;set_variation_data( $object, $data );
			} else {
				$this-&gt;set_product_data( $object, $data );
			}

			$this-&gt;set_image_data( $object, $data );
			$this-&gt;set_meta_data( $object, $data );

			$object = apply_filters( &#039;woocommerce_product_import_pre_insert_product_object&#039;, $object, $data );
			$object-&gt;save();

			do_action( &#039;woocommerce_product_import_inserted_product_object&#039;, $object, $data );

			return array(
				&#039;id&#039;      =&gt; $object-&gt;get_id(),
				&#039;updated&#039; =&gt; $updating,
			);
		} catch ( Exception $e ) {
			return new WP_Error( &#039;woocommerce_product_importer_error&#039;, $e-&gt;getMessage(), array( &#039;status&#039; =&gt; $e-&gt;getCode() ) );
		}
	}

	/**
	 * Convert raw image URLs to IDs and set.
	 *
	 * @param WC_Product $product Product instance.
	 * @param array      $data    Item data.
	 */
	protected function set_image_data( &amp;$product, $data ) {
		// Image URLs need converting to IDs before inserting.
		if ( isset( $data[&#039;raw_image_id&#039;] ) ) {
			$product-&gt;set_image_id( $this-&gt;get_attachment_id_from_url( $data[&#039;raw_image_id&#039;], $product-&gt;get_id() ) );
		}

		// Gallery image URLs need converting to IDs before inserting.
		if ( isset( $data[&#039;raw_gallery_image_ids&#039;] ) ) {
			$gallery_image_ids = array();

			foreach ( $data[&#039;raw_gallery_image_ids&#039;] as $image_id ) {
				$gallery_image_ids[] = $this-&gt;get_attachment_id_from_url( $image_id, $product-&gt;get_id() );
			}
			$product-&gt;set_gallery_image_ids( $gallery_image_ids );
		}
	}

	/**
	 * Append meta data.
	 *
	 * @param WC_Product $product Product instance.
	 * @param array      $data    Item data.
	 */
	protected function set_meta_data( &amp;$product, $data ) {
		if ( isset( $data[&#039;meta_data&#039;] ) ) {
			foreach ( $data[&#039;meta_data&#039;] as $meta ) {
				$product-&gt;update_meta_data( $meta[&#039;key&#039;], $meta[&#039;value&#039;] );
			}
		}
	}

	/**
	 * Set product data.
	 *
	 * @param WC_Product $product Product instance.
	 * @param array      $data    Item data.
	 * @throws Exception If data cannot be set.
	 */
	protected function set_product_data( &amp;$product, $data ) {
		if ( isset( $data[&#039;raw_attributes&#039;] ) ) {
			$attributes          = array();
			$default_attributes  = array();
			$existing_attributes = $product-&gt;get_attributes();

			foreach ( $data[&#039;raw_attributes&#039;] as $position =&gt; $attribute ) {
				$attribute_id = 0;

				// Get ID if is a global attribute.
				if ( ! empty( $attribute[&#039;taxonomy&#039;] ) ) {
					$attribute_id = $this-&gt;get_attribute_taxonomy_id( $attribute[&#039;name&#039;] );
				}

				// Set attribute visibility.
				if ( isset( $attribute[&#039;visible&#039;] ) ) {
					$is_visible = $attribute[&#039;visible&#039;];
				} else {
					$is_visible = 1;
				}

				// Get name.
				$attribute_name = $attribute_id ? wc_attribute_taxonomy_name_by_id( $attribute_id ) : $attribute[&#039;name&#039;];

				// Set if is a variation attribute based on existing attributes if possible so updates via CSV do not change this.
				$is_variation = 0;

				if ( $existing_attributes ) {
					foreach ( $existing_attributes as $existing_attribute ) {
						if ( $existing_attribute-&gt;get_name() === $attribute_name ) {
							$is_variation = $existing_attribute-&gt;get_variation();
							break;
						}
					}
				}

				if ( $attribute_id ) {
					if ( isset( $attribute[&#039;value&#039;] ) ) {
						$options = array_map( &#039;wc_sanitize_term_text_based&#039;, $attribute[&#039;value&#039;] );
						$options = array_filter( $options, &#039;strlen&#039; );
					} else {
						$options = array();
					}

					// Check for default attributes and set &quot;is_variation&quot;.
					if ( ! empty( $attribute[&#039;default&#039;] ) &amp;&amp; in_array( $attribute[&#039;default&#039;], $options, true ) ) {
						$default_term = get_term_by( &#039;name&#039;, $attribute[&#039;default&#039;], $attribute_name );

						if ( $default_term &amp;&amp; ! is_wp_error( $default_term ) ) {
							$default = $default_term-&gt;slug;
						} else {
							$default = sanitize_title( $attribute[&#039;default&#039;] );
						}

						$default_attributes[ $attribute_name ] = $default;
						$is_variation                          = 1;
					}

					if ( ! empty( $options ) ) {
						$attribute_object = new WC_Product_Attribute();
						$attribute_object-&gt;set_id( $attribute_id );
						$attribute_object-&gt;set_name( $attribute_name );
						$attribute_object-&gt;set_options( $options );
						$attribute_object-&gt;set_position( $position );
						$attribute_object-&gt;set_visible( $is_visible );
						$attribute_object-&gt;set_variation( $is_variation );
						$attributes[] = $attribute_object;
					}
				} elseif ( isset( $attribute[&#039;value&#039;] ) ) {
					// Check for default attributes and set &quot;is_variation&quot;.
					if ( ! empty( $attribute[&#039;default&#039;] ) &amp;&amp; in_array( $attribute[&#039;default&#039;], $attribute[&#039;value&#039;], true ) ) {
						$default_attributes[ sanitize_title( $attribute[&#039;name&#039;] ) ] = $attribute[&#039;default&#039;];
						$is_variation = 1;
					}

					$attribute_object = new WC_Product_Attribute();
					$attribute_object-&gt;set_name( $attribute[&#039;name&#039;] );
					$attribute_object-&gt;set_options( $attribute[&#039;value&#039;] );
					$attribute_object-&gt;set_position( $position );
					$attribute_object-&gt;set_visible( $is_visible );
					$attribute_object-&gt;set_variation( $is_variation );
					$attributes[] = $attribute_object;
				}
			}

			$product-&gt;set_attributes( $attributes );

			// Set variable default attributes.
			if ( $product-&gt;is_type( &#039;variable&#039; ) ) {
				$product-&gt;set_default_attributes( $default_attributes );
			}
		}
	}

	/**
	 * Set variation data.
	 *
	 * @param WC_Product $variation Product instance.
	 * @param array      $data    Item data.
	 * @return WC_Product|WP_Error
	 * @throws Exception If data cannot be set.
	 */
	protected function set_variation_data( &amp;$variation, $data ) {
		$parent = false;

		// Check if parent exist.
		if ( isset( $data[&#039;parent_id&#039;] ) ) {
			$parent = wc_get_product( $data[&#039;parent_id&#039;] );

			if ( $parent ) {
				$variation-&gt;set_parent_id( $parent-&gt;get_id() );
			}
		}

		// Stop if parent does not exists.
		if ( ! $parent ) {
			return new WP_Error( &#039;woocommerce_product_importer_missing_variation_parent_id&#039;, __( &#039;Variation cannot be imported: Missing parent ID or parent does not exist yet.&#039;, &#039;woocommerce&#039; ), array( &#039;status&#039; =&gt; 401 ) );
		}

		// Stop if parent is a product variation.
		if ( $parent-&gt;is_type( &#039;variation&#039; ) ) {
			return new WP_Error( &#039;woocommerce_product_importer_parent_set_as_variation&#039;, __( &#039;Variation cannot be imported: Parent product cannot be a product variation&#039;, &#039;woocommerce&#039; ), array( &#039;status&#039; =&gt; 401 ) );
		}

		if ( isset( $data[&#039;raw_attributes&#039;] ) ) {
			$attributes        = array();
			$parent_attributes = $this-&gt;get_variation_parent_attributes( $data[&#039;raw_attributes&#039;], $parent );

			foreach ( $data[&#039;raw_attributes&#039;] as $attribute ) {
				$attribute_id = 0;

				// Get ID if is a global attribute.
				if ( ! empty( $attribute[&#039;taxonomy&#039;] ) ) {
					$attribute_id = $this-&gt;get_attribute_taxonomy_id( $attribute[&#039;name&#039;] );
				}

				if ( $attribute_id ) {
					$attribute_name = wc_attribute_taxonomy_name_by_id( $attribute_id );
				} else {
					$attribute_name = sanitize_title( $attribute[&#039;name&#039;] );
				}

				if ( ! isset( $parent_attributes[ $attribute_name ] ) || ! $parent_attributes[ $attribute_name ]-&gt;get_variation() ) {
					continue;
				}

				$attribute_key   = sanitize_title( $parent_attributes[ $attribute_name ]-&gt;get_name() );
				$attribute_value = isset( $attribute[&#039;value&#039;] ) ? current( $attribute[&#039;value&#039;] ) : &#039;&#039;;

				if ( $parent_attributes[ $attribute_name ]-&gt;is_taxonomy() ) {
					// If dealing with a taxonomy, we need to get the slug from the name posted to the API.
					$term = get_term_by( &#039;name&#039;, $attribute_value, $attribute_name );

					if ( $term &amp;&amp; ! is_wp_error( $term ) ) {
						$attribute_value = $term-&gt;slug;
					} else {
						$attribute_value = sanitize_title( $attribute_value );
					}
				}

				$attributes[ $attribute_key ] = $attribute_value;
			}

			$variation-&gt;set_attributes( $attributes );
		}
	}

	/**
	 * Get variation parent attributes and set &quot;is_variation&quot;.
	 *
	 * @param  array      $attributes Attributes list.
	 * @param  WC_Product $parent     Parent product data.
	 * @return array
	 */
	protected function get_variation_parent_attributes( $attributes, $parent ) {
		$parent_attributes = $parent-&gt;get_attributes();
		$require_save      = false;

		foreach ( $attributes as $attribute ) {
			$attribute_id = 0;

			// Get ID if is a global attribute.
			if ( ! empty( $attribute[&#039;taxonomy&#039;] ) ) {
				$attribute_id = $this-&gt;get_attribute_taxonomy_id( $attribute[&#039;name&#039;] );
			}

			if ( $attribute_id ) {
				$attribute_name = wc_attribute_taxonomy_name_by_id( $attribute_id );
			} else {
				$attribute_name = sanitize_title( $attribute[&#039;name&#039;] );
			}

			// Check if attribute handle variations.
			if ( isset( $parent_attributes[ $attribute_name ] ) &amp;&amp; ! $parent_attributes[ $attribute_name ]-&gt;get_variation() ) {
				// Re-create the attribute to CRUD save and generate again.
				$parent_attributes[ $attribute_name ] = clone $parent_attributes[ $attribute_name ];
				$parent_attributes[ $attribute_name ]-&gt;set_variation( 1 );

				$require_save = true;
			}
		}

		// Save variation attributes.
		if ( $require_save ) {
			$parent-&gt;set_attributes( array_values( $parent_attributes ) );
			$parent-&gt;save();
		}

		return $parent_attributes;
	}

	/**
	 * Get attachment ID.
	 *
	 * @param  string $url        Attachment URL.
	 * @param  int    $product_id Product ID.
	 * @return int
	 * @throws Exception If attachment cannot be loaded.
	 */
	public function get_attachment_id_from_url( $url, $product_id ) {
		if ( empty( $url ) ) {
			return 0;
		}

		$id         = 0;
		$upload_dir = wp_upload_dir( null, false );
		$base_url   = $upload_dir[&#039;baseurl&#039;] . &#039;/&#039;;

		// Check first if attachment is inside the WordPress uploads directory, or we&#039;re given a filename only.
		if ( false !== strpos( $url, $base_url ) || false === strpos( $url, &#039;://&#039; ) ) {
			// Search for yyyy/mm/slug.extension or slug.extension - remove the base URL.
			$file = str_replace( $base_url, &#039;&#039;, $url );
			$args = array(
				&#039;post_type&#039;   =&gt; &#039;attachment&#039;,
				&#039;post_status&#039; =&gt; &#039;any&#039;,
				&#039;fields&#039;      =&gt; &#039;ids&#039;,
				&#039;meta_query&#039;  =&gt; array( // @codingStandardsIgnoreLine.
					&#039;relation&#039; =&gt; &#039;OR&#039;,
					array(
						&#039;key&#039;     =&gt; &#039;_wp_attached_file&#039;,
						&#039;value&#039;   =&gt; &#039;^&#039; . $file,
						&#039;compare&#039; =&gt; &#039;REGEXP&#039;,
					),
					array(
						&#039;key&#039;     =&gt; &#039;_wp_attached_file&#039;,
						&#039;value&#039;   =&gt; &#039;/&#039; . $file,
						&#039;compare&#039; =&gt; &#039;LIKE&#039;,
					),
					array(
						&#039;key&#039;     =&gt; &#039;_wc_attachment_source&#039;,
						&#039;value&#039;   =&gt; &#039;/&#039; . $file,
						&#039;compare&#039; =&gt; &#039;LIKE&#039;,
					),
				),
			);
		} else {
			// This is an external URL, so compare to source.
			$args = array(
				&#039;post_type&#039;   =&gt; &#039;attachment&#039;,
				&#039;post_status&#039; =&gt; &#039;any&#039;,
				&#039;fields&#039;      =&gt; &#039;ids&#039;,
				&#039;meta_query&#039;  =&gt; array( // @codingStandardsIgnoreLine.
					array(
						&#039;value&#039; =&gt; $url,
						&#039;key&#039;   =&gt; &#039;_wc_attachment_source&#039;,
					),
				),
			);
		}

		$ids = get_posts( $args ); // @codingStandardsIgnoreLine.

		if ( $ids ) {
			$id = current( $ids );
		}

		// Upload if attachment does not exists.
		if ( ! $id &amp;&amp; stristr( $url, &#039;://&#039; ) ) {
			$upload = wc_rest_upload_image_from_url( $url );

			if ( is_wp_error( $upload ) ) {
				throw new Exception( $upload-&gt;get_error_message(), 400 );
			}

			$id = wc_rest_set_uploaded_image_as_attachment( $upload, $product_id );

			if ( ! wp_attachment_is_image( $id ) ) {
				/* translators: %s: image URL */
				throw new Exception( sprintf( __( &#039;Not able to attach &quot;%s&quot;.&#039;, &#039;woocommerce&#039; ), $url ), 400 );
			}

			// Save attachment source for future reference.
			update_post_meta( $id, &#039;_wc_attachment_source&#039;, $url );
		}

		if ( ! $id ) {
			/* translators: %s: image URL */
			throw new Exception( sprintf( __( &#039;Unable to use image &quot;%s&quot;.&#039;, &#039;woocommerce&#039; ), $url ), 400 );
		}

		return $id;
	}

	/**
	 * Get attribute taxonomy ID from the imported data.
	 * If does not exists register a new attribute.
	 *
	 * @param  string $raw_name Attribute name.
	 * @return int
	 * @throws Exception If taxonomy cannot be loaded.
	 */
	public function get_attribute_taxonomy_id( $raw_name ) {
		global $wpdb, $wc_product_attributes;

		// These are exported as labels, so convert the label to a name if possible first.
		$attribute_labels = wp_list_pluck( wc_get_attribute_taxonomies(), &#039;attribute_label&#039;, &#039;attribute_name&#039; );
		$attribute_name   = array_search( $raw_name, $attribute_labels, true );

		if ( ! $attribute_name ) {
			$attribute_name = wc_sanitize_taxonomy_name( $raw_name );
		}

		$attribute_id = wc_attribute_taxonomy_id_by_name( $attribute_name );

		// Get the ID from the name.
		if ( $attribute_id ) {
			return $attribute_id;
		}

		// If the attribute does not exist, create it.
		$attribute_id = wc_create_attribute(
			array(
				&#039;name&#039;         =&gt; $raw_name,
				&#039;slug&#039;         =&gt; $attribute_name,
				&#039;type&#039;         =&gt; &#039;select&#039;,
				&#039;order_by&#039;     =&gt; &#039;menu_order&#039;,
				&#039;has_archives&#039; =&gt; false,
			)
		);

		if ( is_wp_error( $attribute_id ) ) {
			throw new Exception( $attribute_id-&gt;get_error_message(), 400 );
		}

		// Register as taxonomy while importing.
		$taxonomy_name = wc_attribute_taxonomy_name( $attribute_name );
		register_taxonomy(
			$taxonomy_name,
			apply_filters( &#039;woocommerce_taxonomy_objects_&#039; . $taxonomy_name, array( &#039;product&#039; ) ),
			apply_filters(
				&#039;woocommerce_taxonomy_args_&#039; . $taxonomy_name,
				array(
					&#039;labels&#039;       =&gt; array(
						&#039;name&#039; =&gt; $raw_name,
					),
					&#039;hierarchical&#039; =&gt; true,
					&#039;show_ui&#039;      =&gt; false,
					&#039;query_var&#039;    =&gt; true,
					&#039;rewrite&#039;      =&gt; false,
				)
			)
		);

		// Set product attributes global.
		$wc_product_attributes = array();

		foreach ( wc_get_attribute_taxonomies() as $taxonomy ) {
			$wc_product_attributes[ wc_attribute_taxonomy_name( $taxonomy-&gt;attribute_name ) ] = $taxonomy;
		}

		return $attribute_id;
	}

	/**
	 * Memory exceeded
	 *
	 * Ensures the batch process never exceeds 90%
	 * of the maximum WordPress memory.
	 *
	 * @return bool
	 */
	protected function memory_exceeded() {
		$memory_limit   = $this-&gt;get_memory_limit() * 0.9; // 90% of max memory
		$current_memory = memory_get_usage( true );
		$return         = false;
		if ( $current_memory &gt;= $memory_limit ) {
			$return = true;
		}
		return apply_filters( &#039;woocommerce_product_importer_memory_exceeded&#039;, $return );
	}

	/**
	 * Get memory limit
	 *
	 * @return int
	 */
	protected function get_memory_limit() {
		if ( function_exists( &#039;ini_get&#039; ) ) {
			$memory_limit = ini_get( &#039;memory_limit&#039; );
		} else {
			// Sensible default.
			$memory_limit = &#039;128M&#039;;
		}

		if ( ! $memory_limit || -1 === intval( $memory_limit ) ) {
			// Unlimited, set to 32GB.
			$memory_limit = &#039;32000M&#039;;
		}
		return intval( $memory_limit ) * 1024 * 1024;
	}

	/**
	 * Time exceeded.
	 *
	 * Ensures the batch never exceeds a sensible time limit.
	 * A timeout limit of 30s is common on shared hosting.
	 *
	 * @return bool
	 */
	protected function time_exceeded() {
		$finish = $this-&gt;start_time + apply_filters( &#039;woocommerce_product_importer_default_time_limit&#039;, 20 ); // 20 seconds
		$return = false;
		if ( time() &gt;= $finish ) {
			$return = true;
		}
		return apply_filters( &#039;woocommerce_product_importer_time_exceeded&#039;, $return );
	}

	/**
	 * Explode CSV cell values using commas by default, and handling escaped
	 * separators.
	 *
	 * @since  3.2.0
	 * @param  string $value     Value to explode.
	 * @param  string $separator Separator separating each value. Defaults to comma.
	 * @return array
	 */
	protected function explode_values( $value, $separator = &#039;,&#039; ) {
		$value  = str_replace( &#039;\\,&#039;, &#039;::separator::&#039;, $value );
		$values = explode( $separator, $value );
		$values = array_map( array( $this, &#039;explode_values_formatter&#039; ), $values );

		return $values;
	}

	/**
	 * Remove formatting and trim each value.
	 *
	 * @since  3.2.0
	 * @param  string $value Value to format.
	 * @return string
	 */
	protected function explode_values_formatter( $value ) {
		return trim( str_replace( &#039;::separator::&#039;, &#039;,&#039;, $value ) );
	}

	/**
	 * The exporter prepends a &#039; to escape fields that start with =, +, - or @.
	 * Remove the prepended &#039; character preceding those characters.
	 *
	 * @since 3.5.2
	 * @param  string $value A string that may or may not have been escaped with &#039;.
	 * @return string
	 */
	protected function unescape_data( $value ) {
		$active_content_triggers = array( &quot;&#039;=&quot;, &quot;&#039;+&quot;, &quot;&#039;-&quot;, &quot;&#039;@&quot; );

		if ( in_array( mb_substr( $value, 0, 2 ), $active_content_triggers, true ) ) {
			$value = mb_substr( $value, 1 );
		}

		return $value;
	}

}
</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>WooCommerce Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on July 12th, 2021 at 10:33 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1626085995"></script>
    <script src="../js/search.js?updated=1626085995"></script>
</body>
</html>
