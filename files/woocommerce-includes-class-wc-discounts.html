<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WooCommerce Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1626085994">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1626085994">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.svg" alt="WooCommerce" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.woocommerce.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">WooCommerce Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="../namespaces/automattic-woocommerce.html"><abbr title="\Automattic\WooCommerce">WooCommerce</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerce.html"><abbr title="\WooCommerce">WooCommerce</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerce-Classes.html"><abbr title="\WooCommerce\Classes">Classes</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Abstracts.html"><abbr title="\WooCommerce\Abstracts">Abstracts</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Admin.html"><abbr title="\WooCommerce\Admin">Admin</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Views.html"><abbr title="\WooCommerce\Views">Views</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Helper.html"><abbr title="\WooCommerce\Helper">Helper</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Templates.html"><abbr title="\WooCommerce\Templates">Templates</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Reports.html"><abbr title="\WooCommerce\Reports">Reports</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Blocks.html"><abbr title="\WooCommerce\Blocks">Blocks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-RestApi.html"><abbr title="\WooCommerce\RestApi">RestApi</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-CLI.html"><abbr title="\WooCommerce\CLI">CLI</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-l10n.html"><abbr title="\WooCommerce\l10n">l10n</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Webhooks.html"><abbr title="\WooCommerce\Webhooks">Webhooks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-DataStores.html"><abbr title="\WooCommerce\DataStores">DataStores</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Emails.html"><abbr title="\WooCommerce\Emails">Emails</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Export.html"><abbr title="\WooCommerce\Export">Export</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Gateways.html"><abbr title="\WooCommerce\Gateways">Gateways</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-PayPal.html"><abbr title="\WooCommerce\PayPal">PayPal</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Import.html"><abbr title="\WooCommerce\Import">Import</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Integrations.html"><abbr title="\WooCommerce\Integrations">Integrations</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Interfaces.html"><abbr title="\WooCommerce\Interfaces">Interfaces</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Interface.html"><abbr title="\WooCommerce\Interface">Interface</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-LogHandlers.html"><abbr title="\WooCommerce\LogHandlers">LogHandlers</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-PaymentTokens.html"><abbr title="\WooCommerce\PaymentTokens">PaymentTokens</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Utilities.html"><abbr title="\WooCommerce\Utilities">Utilities</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Shipping.html"><abbr title="\WooCommerce\Shipping">Shipping</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Shortcodes.html"><abbr title="\WooCommerce\Shortcodes">Shortcodes</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Tracks.html"><abbr title="\WooCommerce\Tracks">Tracks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Traits.html"><abbr title="\WooCommerce\Traits">Traits</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Functions.html"><abbr title="\WooCommerce\Functions">Functions</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-WCCom.html"><abbr title="\WooCommerce\WCCom">WCCom</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Widgets.html"><abbr title="\WooCommerce\Widgets">Widgets</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Uninstaller.html"><abbr title="\WooCommerce\Uninstaller">Uninstaller</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WoocommerceAdmin.html"><abbr title="\WoocommerceAdmin">WoocommerceAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WoocommerceNavigation.html"><abbr title="\WoocommerceNavigation">WoocommerceNavigation</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/Automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/Automattic-WooCommerce.html"><abbr title="\Automattic\WooCommerce">WooCommerce</abbr></a></li>
                            </ul>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-wc-discounts.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * Discount calculation
 *
 * @package WooCommerce\Classes
 * @since   3.2.0
 */

use Automattic\WooCommerce\Utilities\NumberUtil;

defined( &#039;ABSPATH&#039; ) || exit;

/**
 * Discounts class.
 */
class WC_Discounts {

	/**
	 * Reference to cart or order object.
	 *
	 * @since 3.2.0
	 * @var WC_Cart|WC_Order
	 */
	protected $object;

	/**
	 * An array of items to discount.
	 *
	 * @var array
	 */
	protected $items = array();

	/**
	 * An array of discounts which have been applied to items.
	 *
	 * @var array[] Code =&gt; Item Key =&gt; Value
	 */
	protected $discounts = array();

	/**
	 * WC_Discounts Constructor.
	 *
	 * @param WC_Cart|WC_Order $object Cart or order object.
	 */
	public function __construct( $object = null ) {
		if ( is_a( $object, &#039;WC_Cart&#039; ) ) {
			$this-&gt;set_items_from_cart( $object );
		} elseif ( is_a( $object, &#039;WC_Order&#039; ) ) {
			$this-&gt;set_items_from_order( $object );
		}
	}

	/**
	 * Set items directly. Used by WC_Cart_Totals.
	 *
	 * @since 3.2.3
	 * @param array $items Items to set.
	 */
	public function set_items( $items ) {
		$this-&gt;items     = $items;
		$this-&gt;discounts = array();
		uasort( $this-&gt;items, array( $this, &#039;sort_by_price&#039; ) );
	}

	/**
	 * Normalise cart items which will be discounted.
	 *
	 * @since 3.2.0
	 * @param WC_Cart $cart Cart object.
	 */
	public function set_items_from_cart( $cart ) {
		$this-&gt;items     = array();
		$this-&gt;discounts = array();

		if ( ! is_a( $cart, &#039;WC_Cart&#039; ) ) {
			return;
		}

		$this-&gt;object = $cart;

		foreach ( $cart-&gt;get_cart() as $key =&gt; $cart_item ) {
			$item                = new stdClass();
			$item-&gt;key           = $key;
			$item-&gt;object        = $cart_item;
			$item-&gt;product       = $cart_item[&#039;data&#039;];
			$item-&gt;quantity      = $cart_item[&#039;quantity&#039;];
			$item-&gt;price         = wc_add_number_precision_deep( $item-&gt;product-&gt;get_price() * $item-&gt;quantity );
			$this-&gt;items[ $key ] = $item;
		}

		uasort( $this-&gt;items, array( $this, &#039;sort_by_price&#039; ) );
	}

	/**
	 * Normalise order items which will be discounted.
	 *
	 * @since 3.2.0
	 * @param WC_Order $order Order object.
	 */
	public function set_items_from_order( $order ) {
		$this-&gt;items     = array();
		$this-&gt;discounts = array();

		if ( ! is_a( $order, &#039;WC_Order&#039; ) ) {
			return;
		}

		$this-&gt;object = $order;

		foreach ( $order-&gt;get_items() as $order_item ) {
			$item           = new stdClass();
			$item-&gt;key      = $order_item-&gt;get_id();
			$item-&gt;object   = $order_item;
			$item-&gt;product  = $order_item-&gt;get_product();
			$item-&gt;quantity = $order_item-&gt;get_quantity();
			$item-&gt;price    = wc_add_number_precision_deep( $order_item-&gt;get_subtotal() );

			if ( $order-&gt;get_prices_include_tax() ) {
				$item-&gt;price += wc_add_number_precision_deep( $order_item-&gt;get_subtotal_tax() );
			}

			$this-&gt;items[ $order_item-&gt;get_id() ] = $item;
		}

		uasort( $this-&gt;items, array( $this, &#039;sort_by_price&#039; ) );
	}

	/**
	 * Get the object concerned.
	 *
	 * @since  3.3.2
	 * @return object
	 */
	public function get_object() {
		return $this-&gt;object;
	}

	/**
	 * Get items.
	 *
	 * @since  3.2.0
	 * @return object[]
	 */
	public function get_items() {
		return $this-&gt;items;
	}

	/**
	 * Get items to validate.
	 *
	 * @since  3.3.2
	 * @return object[]
	 */
	public function get_items_to_validate() {
		return apply_filters( &#039;woocommerce_coupon_get_items_to_validate&#039;, $this-&gt;get_items(), $this );
	}

	/**
	 * Get discount by key with or without precision.
	 *
	 * @since  3.2.0
	 * @param  string $key name of discount row to return.
	 * @param  bool   $in_cents Should the totals be returned in cents, or without precision.
	 * @return float
	 */
	public function get_discount( $key, $in_cents = false ) {
		$item_discount_totals = $this-&gt;get_discounts_by_item( $in_cents );
		return isset( $item_discount_totals[ $key ] ) ? $item_discount_totals[ $key ] : 0;
	}

	/**
	 * Get all discount totals.
	 *
	 * @since  3.2.0
	 * @param  bool $in_cents Should the totals be returned in cents, or without precision.
	 * @return array
	 */
	public function get_discounts( $in_cents = false ) {
		$discounts = $this-&gt;discounts;
		return $in_cents ? $discounts : wc_remove_number_precision_deep( $discounts );
	}

	/**
	 * Get all discount totals per item.
	 *
	 * @since  3.2.0
	 * @param  bool $in_cents Should the totals be returned in cents, or without precision.
	 * @return array
	 */
	public function get_discounts_by_item( $in_cents = false ) {
		$discounts            = $this-&gt;discounts;
		$item_discount_totals = (array) array_shift( $discounts );

		foreach ( $discounts as $item_discounts ) {
			foreach ( $item_discounts as $item_key =&gt; $item_discount ) {
				$item_discount_totals[ $item_key ] += $item_discount;
			}
		}

		return $in_cents ? $item_discount_totals : wc_remove_number_precision_deep( $item_discount_totals );
	}

	/**
	 * Get all discount totals per coupon.
	 *
	 * @since  3.2.0
	 * @param  bool $in_cents Should the totals be returned in cents, or without precision.
	 * @return array
	 */
	public function get_discounts_by_coupon( $in_cents = false ) {
		$coupon_discount_totals = array_map( &#039;array_sum&#039;, $this-&gt;discounts );

		return $in_cents ? $coupon_discount_totals : wc_remove_number_precision_deep( $coupon_discount_totals );
	}

	/**
	 * Get discounted price of an item without precision.
	 *
	 * @since  3.2.0
	 * @param  object $item Get data for this item.
	 * @return float
	 */
	public function get_discounted_price( $item ) {
		return wc_remove_number_precision_deep( $this-&gt;get_discounted_price_in_cents( $item ) );
	}

	/**
	 * Get discounted price of an item to precision (in cents).
	 *
	 * @since  3.2.0
	 * @param  object $item Get data for this item.
	 * @return int
	 */
	public function get_discounted_price_in_cents( $item ) {
		return absint( NumberUtil::round( $item-&gt;price - $this-&gt;get_discount( $item-&gt;key, true ) ) );
	}

	/**
	 * Apply a discount to all items using a coupon.
	 *
	 * @since  3.2.0
	 * @param  WC_Coupon $coupon Coupon object being applied to the items.
	 * @param  bool      $validate Set to false to skip coupon validation.
	 * @throws Exception Error message when coupon isn&#039;t valid.
	 * @return bool|WP_Error True if applied or WP_Error instance in failure.
	 */
	public function apply_coupon( $coupon, $validate = true ) {
		if ( ! is_a( $coupon, &#039;WC_Coupon&#039; ) ) {
			return new WP_Error( &#039;invalid_coupon&#039;, __( &#039;Invalid coupon&#039;, &#039;woocommerce&#039; ) );
		}

		$is_coupon_valid = $validate ? $this-&gt;is_coupon_valid( $coupon ) : true;

		if ( is_wp_error( $is_coupon_valid ) ) {
			return $is_coupon_valid;
		}

		if ( ! isset( $this-&gt;discounts[ $coupon-&gt;get_code() ] ) ) {
			$this-&gt;discounts[ $coupon-&gt;get_code() ] = array_fill_keys( array_keys( $this-&gt;items ), 0 );
		}

		$items_to_apply = $this-&gt;get_items_to_apply_coupon( $coupon );

		// Core discounts are handled here as of 3.2.
		switch ( $coupon-&gt;get_discount_type() ) {
			case &#039;percent&#039;:
				$this-&gt;apply_coupon_percent( $coupon, $items_to_apply );
				break;
			case &#039;fixed_product&#039;:
				$this-&gt;apply_coupon_fixed_product( $coupon, $items_to_apply );
				break;
			case &#039;fixed_cart&#039;:
				$this-&gt;apply_coupon_fixed_cart( $coupon, $items_to_apply );
				break;
			default:
				$this-&gt;apply_coupon_custom( $coupon, $items_to_apply );
				break;
		}

		return true;
	}

	/**
	 * Sort by price.
	 *
	 * @since  3.2.0
	 * @param  array $a First element.
	 * @param  array $b Second element.
	 * @return int
	 */
	protected function sort_by_price( $a, $b ) {
		$price_1 = $a-&gt;price * $a-&gt;quantity;
		$price_2 = $b-&gt;price * $b-&gt;quantity;
		if ( $price_1 === $price_2 ) {
			return 0;
		}
		return ( $price_1 &lt; $price_2 ) ? 1 : -1;
	}

	/**
	 * Filter out all products which have been fully discounted to 0.
	 * Used as array_filter callback.
	 *
	 * @since  3.2.0
	 * @param  object $item Get data for this item.
	 * @return bool
	 */
	protected function filter_products_with_price( $item ) {
		return $this-&gt;get_discounted_price_in_cents( $item ) &gt; 0;
	}

	/**
	 * Get items which the coupon should be applied to.
	 *
	 * @since  3.2.0
	 * @param  object $coupon Coupon object.
	 * @return array
	 */
	protected function get_items_to_apply_coupon( $coupon ) {
		$items_to_apply = array();

		foreach ( $this-&gt;get_items_to_validate() as $item ) {
			$item_to_apply = clone $item; // Clone the item so changes to this item do not affect the originals.

			if ( 0 === $this-&gt;get_discounted_price_in_cents( $item_to_apply ) || 0 &gt;= $item_to_apply-&gt;quantity ) {
				continue;
			}

			if ( ! $coupon-&gt;is_valid_for_product( $item_to_apply-&gt;product, $item_to_apply-&gt;object ) &amp;&amp; ! $coupon-&gt;is_valid_for_cart() ) {
				continue;
			}

			$items_to_apply[] = $item_to_apply;
		}
		return $items_to_apply;
	}

	/**
	 * Apply percent discount to items and return an array of discounts granted.
	 *
	 * @since  3.2.0
	 * @param  WC_Coupon $coupon Coupon object. Passed through filters.
	 * @param  array     $items_to_apply Array of items to apply the coupon to.
	 * @return int Total discounted.
	 */
	protected function apply_coupon_percent( $coupon, $items_to_apply ) {
		$total_discount        = 0;
		$cart_total            = 0;
		$limit_usage_qty       = 0;
		$applied_count         = 0;
		$adjust_final_discount = true;

		if ( null !== $coupon-&gt;get_limit_usage_to_x_items() ) {
			$limit_usage_qty = $coupon-&gt;get_limit_usage_to_x_items();
		}

		$coupon_amount = $coupon-&gt;get_amount();

		foreach ( $items_to_apply as $item ) {
			// Find out how much price is available to discount for the item.
			$discounted_price = $this-&gt;get_discounted_price_in_cents( $item );

			// Get the price we actually want to discount, based on settings.
			$price_to_discount = ( &#039;yes&#039; === get_option( &#039;woocommerce_calc_discounts_sequentially&#039;, &#039;no&#039; ) ) ? $discounted_price : NumberUtil::round( $item-&gt;price );

			// See how many and what price to apply to.
			$apply_quantity    = $limit_usage_qty &amp;&amp; ( $limit_usage_qty - $applied_count ) &lt; $item-&gt;quantity ? $limit_usage_qty - $applied_count : $item-&gt;quantity;
			$apply_quantity    = max( 0, apply_filters( &#039;woocommerce_coupon_get_apply_quantity&#039;, $apply_quantity, $item, $coupon, $this ) );
			$price_to_discount = ( $price_to_discount / $item-&gt;quantity ) * $apply_quantity;

			// Run coupon calculations.
			$discount = floor( $price_to_discount * ( $coupon_amount / 100 ) );

			if ( is_a( $this-&gt;object, &#039;WC_Cart&#039; ) &amp;&amp; has_filter( &#039;woocommerce_coupon_get_discount_amount&#039; ) ) {
				// Send through the legacy filter, but not as cents.
				$filtered_discount = wc_add_number_precision( apply_filters( &#039;woocommerce_coupon_get_discount_amount&#039;, wc_remove_number_precision( $discount ), wc_remove_number_precision( $price_to_discount ), $item-&gt;object, false, $coupon ) );

				if ( $filtered_discount !== $discount ) {
					$discount              = $filtered_discount;
					$adjust_final_discount = false;
				}
			}

			$discount       = wc_round_discount( min( $discounted_price, $discount ), 0 );
			$cart_total     = $cart_total + $price_to_discount;
			$total_discount = $total_discount + $discount;
			$applied_count  = $applied_count + $apply_quantity;

			// Store code and discount amount per item.
			$this-&gt;discounts[ $coupon-&gt;get_code() ][ $item-&gt;key ] += $discount;
		}

		// Work out how much discount would have been given to the cart as a whole and compare to what was discounted on all line items.
		$cart_total_discount = wc_round_discount( $cart_total * ( $coupon_amount / 100 ), 0 );

		if ( $total_discount &lt; $cart_total_discount &amp;&amp; $adjust_final_discount ) {
			$total_discount += $this-&gt;apply_coupon_remainder( $coupon, $items_to_apply, $cart_total_discount - $total_discount );
		}

		return $total_discount;
	}

	/**
	 * Apply fixed product discount to items.
	 *
	 * @since  3.2.0
	 * @param  WC_Coupon $coupon Coupon object. Passed through filters.
	 * @param  array     $items_to_apply Array of items to apply the coupon to.
	 * @param  int       $amount Fixed discount amount to apply in cents. Leave blank to pull from coupon.
	 * @return int Total discounted.
	 */
	protected function apply_coupon_fixed_product( $coupon, $items_to_apply, $amount = null ) {
		$total_discount  = 0;
		$amount          = $amount ? $amount : wc_add_number_precision( $coupon-&gt;get_amount() );
		$limit_usage_qty = 0;
		$applied_count   = 0;

		if ( null !== $coupon-&gt;get_limit_usage_to_x_items() ) {
			$limit_usage_qty = $coupon-&gt;get_limit_usage_to_x_items();
		}

		foreach ( $items_to_apply as $item ) {
			// Find out how much price is available to discount for the item.
			$discounted_price = $this-&gt;get_discounted_price_in_cents( $item );

			// Get the price we actually want to discount, based on settings.
			$price_to_discount = ( &#039;yes&#039; === get_option( &#039;woocommerce_calc_discounts_sequentially&#039;, &#039;no&#039; ) ) ? $discounted_price : $item-&gt;price;

			// Run coupon calculations.
			if ( $limit_usage_qty ) {
				$apply_quantity = $limit_usage_qty - $applied_count &lt; $item-&gt;quantity ? $limit_usage_qty - $applied_count : $item-&gt;quantity;
				$apply_quantity = max( 0, apply_filters( &#039;woocommerce_coupon_get_apply_quantity&#039;, $apply_quantity, $item, $coupon, $this ) );
				$discount       = min( $amount, $item-&gt;price / $item-&gt;quantity ) * $apply_quantity;
			} else {
				$apply_quantity = apply_filters( &#039;woocommerce_coupon_get_apply_quantity&#039;, $item-&gt;quantity, $item, $coupon, $this );
				$discount       = $amount * $apply_quantity;
			}

			if ( is_a( $this-&gt;object, &#039;WC_Cart&#039; ) &amp;&amp; has_filter( &#039;woocommerce_coupon_get_discount_amount&#039; ) ) {
				// Send through the legacy filter, but not as cents.
				$discount = wc_add_number_precision( apply_filters( &#039;woocommerce_coupon_get_discount_amount&#039;, wc_remove_number_precision( $discount ), wc_remove_number_precision( $price_to_discount ), $item-&gt;object, false, $coupon ) );
			}

			$discount       = min( $discounted_price, $discount );
			$total_discount = $total_discount + $discount;
			$applied_count  = $applied_count + $apply_quantity;

			// Store code and discount amount per item.
			$this-&gt;discounts[ $coupon-&gt;get_code() ][ $item-&gt;key ] += $discount;
		}
		return $total_discount;
	}

	/**
	 * Apply fixed cart discount to items.
	 *
	 * @since  3.2.0
	 * @param  WC_Coupon $coupon Coupon object. Passed through filters.
	 * @param  array     $items_to_apply Array of items to apply the coupon to.
	 * @param  int       $amount Fixed discount amount to apply in cents. Leave blank to pull from coupon.
	 * @return int Total discounted.
	 */
	protected function apply_coupon_fixed_cart( $coupon, $items_to_apply, $amount = null ) {
		$total_discount = 0;
		$amount         = $amount ? $amount : wc_add_number_precision( $coupon-&gt;get_amount() );
		$items_to_apply = array_filter( $items_to_apply, array( $this, &#039;filter_products_with_price&#039; ) );
		$item_count     = array_sum( wp_list_pluck( $items_to_apply, &#039;quantity&#039; ) );

		if ( ! $item_count ) {
			return $total_discount;
		}

		if ( ! $amount ) {
			// If there is no amount we still send it through so filters are fired.
			$total_discount = $this-&gt;apply_coupon_fixed_product( $coupon, $items_to_apply, 0 );
		} else {
			$per_item_discount = absint( $amount / $item_count ); // round it down to the nearest cent.

			if ( $per_item_discount &gt; 0 ) {
				$total_discount = $this-&gt;apply_coupon_fixed_product( $coupon, $items_to_apply, $per_item_discount );

				/**
				 * If there is still discount remaining, repeat the process.
				 */
				if ( $total_discount &gt; 0 &amp;&amp; $total_discount &lt; $amount ) {
					$total_discount += $this-&gt;apply_coupon_fixed_cart( $coupon, $items_to_apply, $amount - $total_discount );
				}
			} elseif ( $amount &gt; 0 ) {
				$total_discount += $this-&gt;apply_coupon_remainder( $coupon, $items_to_apply, $amount );
			}
		}
		return $total_discount;
	}

	/**
	 * Apply custom coupon discount to items.
	 *
	 * @since  3.3
	 * @param  WC_Coupon $coupon Coupon object. Passed through filters.
	 * @param  array     $items_to_apply Array of items to apply the coupon to.
	 * @return int Total discounted.
	 */
	protected function apply_coupon_custom( $coupon, $items_to_apply ) {
		$limit_usage_qty = 0;
		$applied_count   = 0;

		if ( null !== $coupon-&gt;get_limit_usage_to_x_items() ) {
			$limit_usage_qty = $coupon-&gt;get_limit_usage_to_x_items();
		}

		// Apply the coupon to each item.
		foreach ( $items_to_apply as $item ) {
			// Find out how much price is available to discount for the item.
			$discounted_price = $this-&gt;get_discounted_price_in_cents( $item );

			// Get the price we actually want to discount, based on settings.
			$price_to_discount = wc_remove_number_precision( ( &#039;yes&#039; === get_option( &#039;woocommerce_calc_discounts_sequentially&#039;, &#039;no&#039; ) ) ? $discounted_price : $item-&gt;price );

			// See how many and what price to apply to.
			$apply_quantity = $limit_usage_qty &amp;&amp; ( $limit_usage_qty - $applied_count ) &lt; $item-&gt;quantity ? $limit_usage_qty - $applied_count : $item-&gt;quantity;
			$apply_quantity = max( 0, apply_filters( &#039;woocommerce_coupon_get_apply_quantity&#039;, $apply_quantity, $item, $coupon, $this ) );

			// Run coupon calculations.
			$discount      = wc_add_number_precision( $coupon-&gt;get_discount_amount( $price_to_discount / $item-&gt;quantity, $item-&gt;object, true ) ) * $apply_quantity;
			$discount      = wc_round_discount( min( $discounted_price, $discount ), 0 );
			$applied_count = $applied_count + $apply_quantity;

			// Store code and discount amount per item.
			$this-&gt;discounts[ $coupon-&gt;get_code() ][ $item-&gt;key ] += $discount;
		}

		// Allow post-processing for custom coupon types (e.g. calculating discrepancy, etc).
		$this-&gt;discounts[ $coupon-&gt;get_code() ] = apply_filters( &#039;woocommerce_coupon_custom_discounts_array&#039;, $this-&gt;discounts[ $coupon-&gt;get_code() ], $coupon );

		return array_sum( $this-&gt;discounts[ $coupon-&gt;get_code() ] );
	}

	/**
	 * Deal with remaining fractional discounts by splitting it over items
	 * until the amount is expired, discounting 1 cent at a time.
	 *
	 * @since 3.2.0
	 * @param  WC_Coupon $coupon Coupon object if appliable. Passed through filters.
	 * @param  array     $items_to_apply Array of items to apply the coupon to.
	 * @param  int       $amount Fixed discount amount to apply.
	 * @return int Total discounted.
	 */
	protected function apply_coupon_remainder( $coupon, $items_to_apply, $amount ) {
		$total_discount = 0;

		foreach ( $items_to_apply as $item ) {
			for ( $i = 0; $i &lt; $item-&gt;quantity; $i ++ ) {
				// Find out how much price is available to discount for the item.
				$price_to_discount = $this-&gt;get_discounted_price_in_cents( $item );

				// Run coupon calculations.
				$discount = min( $price_to_discount, 1 );

				// Store totals.
				$total_discount += $discount;

				// Store code and discount amount per item.
				$this-&gt;discounts[ $coupon-&gt;get_code() ][ $item-&gt;key ] += $discount;

				if ( $total_discount &gt;= $amount ) {
					break 2;
				}
			}
			if ( $total_discount &gt;= $amount ) {
				break;
			}
		}
		return $total_discount;
	}

	/**
	 * Ensure coupon exists or throw exception.
	 *
	 * @since  3.2.0
	 * @throws Exception Error message.
	 * @param  WC_Coupon $coupon Coupon data.
	 * @return bool
	 */
	protected function validate_coupon_exists( $coupon ) {
		if ( ! $coupon-&gt;get_id() &amp;&amp; ! $coupon-&gt;get_virtual() ) {
			/* translators: %s: coupon code */
			throw new Exception( sprintf( __( &#039;Coupon &quot;%s&quot; does not exist!&#039;, &#039;woocommerce&#039; ), esc_html( $coupon-&gt;get_code() ) ), 105 );
		}

		return true;
	}

	/**
	 * Ensure coupon usage limit is valid or throw exception.
	 *
	 * @since  3.2.0
	 * @throws Exception Error message.
	 * @param  WC_Coupon $coupon Coupon data.
	 * @return bool
	 */
	protected function validate_coupon_usage_limit( $coupon ) {
		if ( ! $coupon-&gt;get_usage_limit() ) {
			return true;
		}
		$usage_count           = $coupon-&gt;get_usage_count();
		$data_store            = $coupon-&gt;get_data_store();
		$tentative_usage_count = is_callable( array( $data_store, &#039;get_tentative_usage_count&#039; ) ) ? $data_store-&gt;get_tentative_usage_count( $coupon-&gt;get_id() ) : 0;
		if ( $usage_count + $tentative_usage_count &lt; $coupon-&gt;get_usage_limit() ) {
			// All good.
			return true;
		}
		// Coupon usage limit is reached. Let&#039;s show as informative error message as we can.
		if ( 0 === $tentative_usage_count ) {
			// No held coupon, usage limit is indeed reached.
			$error_code = WC_Coupon::E_WC_COUPON_USAGE_LIMIT_REACHED;
		} elseif ( is_user_logged_in() ) {
			$recent_pending_orders = wc_get_orders(
				array(
					&#039;limit&#039;       =&gt; 1,
					&#039;post_status&#039; =&gt; array( &#039;wc-failed&#039;, &#039;wc-pending&#039; ),
					&#039;customer&#039;    =&gt; get_current_user_id(),
					&#039;return&#039;      =&gt; &#039;ids&#039;,
				)
			);
			if ( count( $recent_pending_orders ) &gt; 0 ) {
				// User logged in and have a pending order, maybe they are trying to use the coupon.
				$error_code = WC_Coupon::E_WC_COUPON_USAGE_LIMIT_COUPON_STUCK;
			} else {
				$error_code = WC_Coupon::E_WC_COUPON_USAGE_LIMIT_REACHED;
			}
		} else {
			// Maybe this user was trying to use the coupon but got stuck. We can&#039;t know for sure (performantly). Show a slightly better error message.
			$error_code = WC_Coupon::E_WC_COUPON_USAGE_LIMIT_COUPON_STUCK_GUEST;
		}
		throw new Exception( $coupon-&gt;get_coupon_error( $error_code ), $error_code );
	}

	/**
	 * Ensure coupon user usage limit is valid or throw exception.
	 *
	 * Per user usage limit - check here if user is logged in (against user IDs).
	 * Checked again for emails later on in WC_Cart::check_customer_coupons().
	 *
	 * @since  3.2.0
	 * @throws Exception Error message.
	 * @param  WC_Coupon $coupon  Coupon data.
	 * @param  int       $user_id User ID.
	 * @return bool
	 */
	protected function validate_coupon_user_usage_limit( $coupon, $user_id = 0 ) {
		if ( empty( $user_id ) ) {
			if ( $this-&gt;object instanceof WC_Order ) {
				$user_id = $this-&gt;object-&gt;get_customer_id();
			} else {
				$user_id = get_current_user_id();
			}
		}

		if ( $coupon &amp;&amp; $user_id &amp;&amp; apply_filters( &#039;woocommerce_coupon_validate_user_usage_limit&#039;, $coupon-&gt;get_usage_limit_per_user() &gt; 0, $user_id, $coupon, $this ) &amp;&amp; $coupon-&gt;get_id() &amp;&amp; $coupon-&gt;get_data_store() ) {
			$data_store  = $coupon-&gt;get_data_store();
			$usage_count = $data_store-&gt;get_usage_by_user_id( $coupon, $user_id );
			if ( $usage_count &gt;= $coupon-&gt;get_usage_limit_per_user() ) {
				if ( $data_store-&gt;get_tentative_usages_for_user( $coupon-&gt;get_id(), array( $user_id ) ) &gt; 0 ) {
					$error_message = $coupon-&gt;get_coupon_error( WC_Coupon::E_WC_COUPON_USAGE_LIMIT_COUPON_STUCK );
					$error_code    = WC_Coupon::E_WC_COUPON_USAGE_LIMIT_COUPON_STUCK;
				} else {
					$error_message = $coupon-&gt;get_coupon_error( WC_Coupon::E_WC_COUPON_USAGE_LIMIT_REACHED );
					$error_code    = WC_Coupon::E_WC_COUPON_USAGE_LIMIT_REACHED;
				}
				throw new Exception( $error_message, $error_code );
			}
		}

		return true;
	}

	/**
	 * Ensure coupon date is valid or throw exception.
	 *
	 * @since  3.2.0
	 * @throws Exception Error message.
	 * @param  WC_Coupon $coupon Coupon data.
	 * @return bool
	 */
	protected function validate_coupon_expiry_date( $coupon ) {
		if ( $coupon-&gt;get_date_expires() &amp;&amp; apply_filters( &#039;woocommerce_coupon_validate_expiry_date&#039;, time() &gt; $coupon-&gt;get_date_expires()-&gt;getTimestamp(), $coupon, $this ) ) {
			throw new Exception( __( &#039;This coupon has expired.&#039;, &#039;woocommerce&#039; ), 107 );
		}

		return true;
	}

	/**
	 * Ensure coupon amount is valid or throw exception.
	 *
	 * @since  3.2.0
	 * @throws Exception Error message.
	 * @param  WC_Coupon $coupon   Coupon data.
	 * @return bool
	 */
	protected function validate_coupon_minimum_amount( $coupon ) {
		$subtotal = wc_remove_number_precision( $this-&gt;get_object_subtotal() );

		if ( $coupon-&gt;get_minimum_amount() &gt; 0 &amp;&amp; apply_filters( &#039;woocommerce_coupon_validate_minimum_amount&#039;, $coupon-&gt;get_minimum_amount() &gt; $subtotal, $coupon, $subtotal ) ) {
			/* translators: %s: coupon minimum amount */
			throw new Exception( sprintf( __( &#039;The minimum spend for this coupon is %s.&#039;, &#039;woocommerce&#039; ), wc_price( $coupon-&gt;get_minimum_amount() ) ), 108 );
		}

		return true;
	}

	/**
	 * Ensure coupon amount is valid or throw exception.
	 *
	 * @since  3.2.0
	 * @throws Exception Error message.
	 * @param  WC_Coupon $coupon   Coupon data.
	 * @return bool
	 */
	protected function validate_coupon_maximum_amount( $coupon ) {
		$subtotal = wc_remove_number_precision( $this-&gt;get_object_subtotal() );

		if ( $coupon-&gt;get_maximum_amount() &gt; 0 &amp;&amp; apply_filters( &#039;woocommerce_coupon_validate_maximum_amount&#039;, $coupon-&gt;get_maximum_amount() &lt; $subtotal, $coupon ) ) {
			/* translators: %s: coupon maximum amount */
			throw new Exception( sprintf( __( &#039;The maximum spend for this coupon is %s.&#039;, &#039;woocommerce&#039; ), wc_price( $coupon-&gt;get_maximum_amount() ) ), 112 );
		}

		return true;
	}

	/**
	 * Ensure coupon is valid for products in the list is valid or throw exception.
	 *
	 * @since  3.2.0
	 * @throws Exception Error message.
	 * @param  WC_Coupon $coupon Coupon data.
	 * @return bool
	 */
	protected function validate_coupon_product_ids( $coupon ) {
		if ( count( $coupon-&gt;get_product_ids() ) &gt; 0 ) {
			$valid = false;

			foreach ( $this-&gt;get_items_to_validate() as $item ) {
				if ( $item-&gt;product &amp;&amp; in_array( $item-&gt;product-&gt;get_id(), $coupon-&gt;get_product_ids(), true ) || in_array( $item-&gt;product-&gt;get_parent_id(), $coupon-&gt;get_product_ids(), true ) ) {
					$valid = true;
					break;
				}
			}

			if ( ! $valid ) {
				throw new Exception( __( &#039;Sorry, this coupon is not applicable to selected products.&#039;, &#039;woocommerce&#039; ), 109 );
			}
		}

		return true;
	}

	/**
	 * Ensure coupon is valid for product categories in the list is valid or throw exception.
	 *
	 * @since  3.2.0
	 * @throws Exception Error message.
	 * @param  WC_Coupon $coupon Coupon data.
	 * @return bool
	 */
	protected function validate_coupon_product_categories( $coupon ) {
		if ( count( $coupon-&gt;get_product_categories() ) &gt; 0 ) {
			$valid = false;

			foreach ( $this-&gt;get_items_to_validate() as $item ) {
				if ( $coupon-&gt;get_exclude_sale_items() &amp;&amp; $item-&gt;product &amp;&amp; $item-&gt;product-&gt;is_on_sale() ) {
					continue;
				}

				$product_cats = wc_get_product_cat_ids( $item-&gt;product-&gt;get_id() );

				if ( $item-&gt;product-&gt;get_parent_id() ) {
					$product_cats = array_merge( $product_cats, wc_get_product_cat_ids( $item-&gt;product-&gt;get_parent_id() ) );
				}

				// If we find an item with a cat in our allowed cat list, the coupon is valid.
				if ( count( array_intersect( $product_cats, $coupon-&gt;get_product_categories() ) ) &gt; 0 ) {
					$valid = true;
					break;
				}
			}

			if ( ! $valid ) {
				throw new Exception( __( &#039;Sorry, this coupon is not applicable to selected products.&#039;, &#039;woocommerce&#039; ), 109 );
			}
		}

		return true;
	}

	/**
	 * Ensure coupon is valid for sale items in the list is valid or throw exception.
	 *
	 * @since  3.2.0
	 * @throws Exception Error message.
	 * @param  WC_Coupon $coupon Coupon data.
	 * @return bool
	 */
	protected function validate_coupon_sale_items( $coupon ) {
		if ( $coupon-&gt;get_exclude_sale_items() ) {
			$valid = true;

			foreach ( $this-&gt;get_items_to_validate() as $item ) {
				if ( $item-&gt;product &amp;&amp; $item-&gt;product-&gt;is_on_sale() ) {
					$valid = false;
					break;
				}
			}

			if ( ! $valid ) {
				throw new Exception( __( &#039;Sorry, this coupon is not valid for sale items.&#039;, &#039;woocommerce&#039; ), 110 );
			}
		}

		return true;
	}

	/**
	 * All exclusion rules must pass at the same time for a product coupon to be valid.
	 *
	 * @since  3.2.0
	 * @throws Exception Error message.
	 * @param  WC_Coupon $coupon Coupon data.
	 * @return bool
	 */
	protected function validate_coupon_excluded_items( $coupon ) {
		$items = $this-&gt;get_items_to_validate();
		if ( ! empty( $items ) &amp;&amp; $coupon-&gt;is_type( wc_get_product_coupon_types() ) ) {
			$valid = false;

			foreach ( $items as $item ) {
				if ( $item-&gt;product &amp;&amp; $coupon-&gt;is_valid_for_product( $item-&gt;product, $item-&gt;object ) ) {
					$valid = true;
					break;
				}
			}

			if ( ! $valid ) {
				throw new Exception( __( &#039;Sorry, this coupon is not applicable to selected products.&#039;, &#039;woocommerce&#039; ), 109 );
			}
		}

		return true;
	}

	/**
	 * Cart discounts cannot be added if non-eligible product is found.
	 *
	 * @since  3.2.0
	 * @throws Exception Error message.
	 * @param  WC_Coupon $coupon Coupon data.
	 * @return bool
	 */
	protected function validate_coupon_eligible_items( $coupon ) {
		if ( ! $coupon-&gt;is_type( wc_get_product_coupon_types() ) ) {
			$this-&gt;validate_coupon_sale_items( $coupon );
			$this-&gt;validate_coupon_excluded_product_ids( $coupon );
			$this-&gt;validate_coupon_excluded_product_categories( $coupon );
		}

		return true;
	}

	/**
	 * Exclude products.
	 *
	 * @since  3.2.0
	 * @throws Exception Error message.
	 * @param  WC_Coupon $coupon Coupon data.
	 * @return bool
	 */
	protected function validate_coupon_excluded_product_ids( $coupon ) {
		// Exclude Products.
		if ( count( $coupon-&gt;get_excluded_product_ids() ) &gt; 0 ) {
			$products = array();

			foreach ( $this-&gt;get_items_to_validate() as $item ) {
				if ( $item-&gt;product &amp;&amp; in_array( $item-&gt;product-&gt;get_id(), $coupon-&gt;get_excluded_product_ids(), true ) || in_array( $item-&gt;product-&gt;get_parent_id(), $coupon-&gt;get_excluded_product_ids(), true ) ) {
					$products[] = $item-&gt;product-&gt;get_name();
				}
			}

			if ( ! empty( $products ) ) {
				/* translators: %s: products list */
				throw new Exception( sprintf( __( &#039;Sorry, this coupon is not applicable to the products: %s.&#039;, &#039;woocommerce&#039; ), implode( &#039;, &#039;, $products ) ), 113 );
			}
		}

		return true;
	}

	/**
	 * Exclude categories from product list.
	 *
	 * @since  3.2.0
	 * @throws Exception Error message.
	 * @param  WC_Coupon $coupon Coupon data.
	 * @return bool
	 */
	protected function validate_coupon_excluded_product_categories( $coupon ) {
		if ( count( $coupon-&gt;get_excluded_product_categories() ) &gt; 0 ) {
			$categories = array();

			foreach ( $this-&gt;get_items_to_validate() as $item ) {
				if ( ! $item-&gt;product ) {
					continue;
				}

				$product_cats = wc_get_product_cat_ids( $item-&gt;product-&gt;get_id() );

				if ( $item-&gt;product-&gt;get_parent_id() ) {
					$product_cats = array_merge( $product_cats, wc_get_product_cat_ids( $item-&gt;product-&gt;get_parent_id() ) );
				}

				$cat_id_list = array_intersect( $product_cats, $coupon-&gt;get_excluded_product_categories() );
				if ( count( $cat_id_list ) &gt; 0 ) {
					foreach ( $cat_id_list as $cat_id ) {
						$cat          = get_term( $cat_id, &#039;product_cat&#039; );
						$categories[] = $cat-&gt;name;
					}
				}
			}

			if ( ! empty( $categories ) ) {
				/* translators: %s: categories list */
				throw new Exception( sprintf( __( &#039;Sorry, this coupon is not applicable to the categories: %s.&#039;, &#039;woocommerce&#039; ), implode( &#039;, &#039;, array_unique( $categories ) ) ), 114 );
			}
		}

		return true;
	}

	/**
	 * Get the object subtotal
	 *
	 * @return int
	 */
	protected function get_object_subtotal() {
		if ( is_a( $this-&gt;object, &#039;WC_Cart&#039; ) ) {
			return wc_add_number_precision( $this-&gt;object-&gt;get_displayed_subtotal() );
		} elseif ( is_a( $this-&gt;object, &#039;WC_Order&#039; ) ) {
			$subtotal = wc_add_number_precision( $this-&gt;object-&gt;get_subtotal() );

			if ( $this-&gt;object-&gt;get_prices_include_tax() ) {
				// Add tax to tax-exclusive subtotal.
				$subtotal = $subtotal + wc_add_number_precision( NumberUtil::round( $this-&gt;object-&gt;get_total_tax(), wc_get_price_decimals() ) );
			}

			return $subtotal;
		} else {
			return array_sum( wp_list_pluck( $this-&gt;items, &#039;price&#039; ) );
		}
	}

	/**
	 * Check if a coupon is valid.
	 *
	 * Error Codes:
	 * - 100: Invalid filtered.
	 * - 101: Invalid removed.
	 * - 102: Not yours removed.
	 * - 103: Already applied.
	 * - 104: Individual use only.
	 * - 105: Not exists.
	 * - 106: Usage limit reached.
	 * - 107: Expired.
	 * - 108: Minimum spend limit not met.
	 * - 109: Not applicable.
	 * - 110: Not valid for sale items.
	 * - 111: Missing coupon code.
	 * - 112: Maximum spend limit met.
	 * - 113: Excluded products.
	 * - 114: Excluded categories.
	 *
	 * @since  3.2.0
	 * @throws Exception Error message.
	 * @param  WC_Coupon $coupon Coupon data.
	 * @return bool|WP_Error
	 */
	public function is_coupon_valid( $coupon ) {
		try {
			$this-&gt;validate_coupon_exists( $coupon );
			$this-&gt;validate_coupon_usage_limit( $coupon );
			$this-&gt;validate_coupon_user_usage_limit( $coupon );
			$this-&gt;validate_coupon_expiry_date( $coupon );
			$this-&gt;validate_coupon_minimum_amount( $coupon );
			$this-&gt;validate_coupon_maximum_amount( $coupon );
			$this-&gt;validate_coupon_product_ids( $coupon );
			$this-&gt;validate_coupon_product_categories( $coupon );
			$this-&gt;validate_coupon_excluded_items( $coupon );
			$this-&gt;validate_coupon_eligible_items( $coupon );

			if ( ! apply_filters( &#039;woocommerce_coupon_is_valid&#039;, true, $coupon, $this ) ) {
				throw new Exception( __( &#039;Coupon is not valid.&#039;, &#039;woocommerce&#039; ), 100 );
			}
		} catch ( Exception $e ) {
			/**
			 * Filter the coupon error message.
			 *
			 * @param string    $error_message Error message.
			 * @param int       $error_code    Error code.
			 * @param WC_Coupon $coupon        Coupon data.
			 */
			$message = apply_filters( &#039;woocommerce_coupon_error&#039;, is_numeric( $e-&gt;getMessage() ) ? $coupon-&gt;get_coupon_error( $e-&gt;getMessage() ) : $e-&gt;getMessage(), $e-&gt;getCode(), $coupon );

			return new WP_Error(
				&#039;invalid_coupon&#039;,
				$message,
				array(
					&#039;status&#039; =&gt; 400,
				)
			);
		}
		return true;
	}
}
</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>WooCommerce Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on July 12th, 2021 at 10:33 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1626085994"></script>
    <script src="../js/search.js?updated=1626085994"></script>
</body>
</html>
