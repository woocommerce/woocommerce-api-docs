<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WooCommerce Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1626085994">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1626085994">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.svg" alt="WooCommerce" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.woocommerce.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">WooCommerce Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="../namespaces/automattic-woocommerce.html"><abbr title="\Automattic\WooCommerce">WooCommerce</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerce.html"><abbr title="\WooCommerce">WooCommerce</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerce-Classes.html"><abbr title="\WooCommerce\Classes">Classes</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Abstracts.html"><abbr title="\WooCommerce\Abstracts">Abstracts</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Admin.html"><abbr title="\WooCommerce\Admin">Admin</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Views.html"><abbr title="\WooCommerce\Views">Views</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Helper.html"><abbr title="\WooCommerce\Helper">Helper</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Templates.html"><abbr title="\WooCommerce\Templates">Templates</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Reports.html"><abbr title="\WooCommerce\Reports">Reports</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Blocks.html"><abbr title="\WooCommerce\Blocks">Blocks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-RestApi.html"><abbr title="\WooCommerce\RestApi">RestApi</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-CLI.html"><abbr title="\WooCommerce\CLI">CLI</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-l10n.html"><abbr title="\WooCommerce\l10n">l10n</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Webhooks.html"><abbr title="\WooCommerce\Webhooks">Webhooks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-DataStores.html"><abbr title="\WooCommerce\DataStores">DataStores</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Emails.html"><abbr title="\WooCommerce\Emails">Emails</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Export.html"><abbr title="\WooCommerce\Export">Export</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Gateways.html"><abbr title="\WooCommerce\Gateways">Gateways</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-PayPal.html"><abbr title="\WooCommerce\PayPal">PayPal</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Import.html"><abbr title="\WooCommerce\Import">Import</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Integrations.html"><abbr title="\WooCommerce\Integrations">Integrations</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Interfaces.html"><abbr title="\WooCommerce\Interfaces">Interfaces</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Interface.html"><abbr title="\WooCommerce\Interface">Interface</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-LogHandlers.html"><abbr title="\WooCommerce\LogHandlers">LogHandlers</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-PaymentTokens.html"><abbr title="\WooCommerce\PaymentTokens">PaymentTokens</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Utilities.html"><abbr title="\WooCommerce\Utilities">Utilities</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Shipping.html"><abbr title="\WooCommerce\Shipping">Shipping</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Shortcodes.html"><abbr title="\WooCommerce\Shortcodes">Shortcodes</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Tracks.html"><abbr title="\WooCommerce\Tracks">Tracks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Traits.html"><abbr title="\WooCommerce\Traits">Traits</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Functions.html"><abbr title="\WooCommerce\Functions">Functions</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-WCCom.html"><abbr title="\WooCommerce\WCCom">WCCom</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Widgets.html"><abbr title="\WooCommerce\Widgets">Widgets</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Uninstaller.html"><abbr title="\WooCommerce\Uninstaller">Uninstaller</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WoocommerceAdmin.html"><abbr title="\WoocommerceAdmin">WoocommerceAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WoocommerceNavigation.html"><abbr title="\WoocommerceNavigation">WoocommerceNavigation</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/Automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/Automattic-WooCommerce.html"><abbr title="\Automattic\WooCommerce">WooCommerce</abbr></a></li>
                            </ul>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-wc-form-handler.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * Handle frontend forms.
 *
 * @package WooCommerce\Classes\
 */

defined( &#039;ABSPATH&#039; ) || exit;

/**
 * WC_Form_Handler class.
 */
class WC_Form_Handler {

	/**
	 * Hook in methods.
	 */
	public static function init() {
		add_action( &#039;template_redirect&#039;, array( __CLASS__, &#039;redirect_reset_password_link&#039; ) );
		add_action( &#039;template_redirect&#039;, array( __CLASS__, &#039;save_address&#039; ) );
		add_action( &#039;template_redirect&#039;, array( __CLASS__, &#039;save_account_details&#039; ) );
		add_action( &#039;wp_loaded&#039;, array( __CLASS__, &#039;checkout_action&#039; ), 20 );
		add_action( &#039;wp_loaded&#039;, array( __CLASS__, &#039;process_login&#039; ), 20 );
		add_action( &#039;wp_loaded&#039;, array( __CLASS__, &#039;process_registration&#039; ), 20 );
		add_action( &#039;wp_loaded&#039;, array( __CLASS__, &#039;process_lost_password&#039; ), 20 );
		add_action( &#039;wp_loaded&#039;, array( __CLASS__, &#039;process_reset_password&#039; ), 20 );
		add_action( &#039;wp_loaded&#039;, array( __CLASS__, &#039;cancel_order&#039; ), 20 );
		add_action( &#039;wp_loaded&#039;, array( __CLASS__, &#039;update_cart_action&#039; ), 20 );
		add_action( &#039;wp_loaded&#039;, array( __CLASS__, &#039;add_to_cart_action&#039; ), 20 );

		// May need $wp global to access query vars.
		add_action( &#039;wp&#039;, array( __CLASS__, &#039;pay_action&#039; ), 20 );
		add_action( &#039;wp&#039;, array( __CLASS__, &#039;add_payment_method_action&#039; ), 20 );
		add_action( &#039;wp&#039;, array( __CLASS__, &#039;delete_payment_method_action&#039; ), 20 );
		add_action( &#039;wp&#039;, array( __CLASS__, &#039;set_default_payment_method_action&#039; ), 20 );
	}

	/**
	 * Remove key and user ID (or user login, as a fallback) from query string, set cookie, and redirect to account page to show the form.
	 */
	public static function redirect_reset_password_link() {
		if ( is_account_page() &amp;&amp; isset( $_GET[&#039;key&#039;] ) &amp;&amp; ( isset( $_GET[&#039;id&#039;] ) || isset( $_GET[&#039;login&#039;] ) ) ) { // phpcs:ignore WordPress.Security.NonceVerification.Recommended

			// If available, get $user_id from query string parameter for fallback purposes.
			if ( isset( $_GET[&#039;login&#039;] ) ) { // phpcs:ignore WordPress.Security.NonceVerification.Recommended
				$user    = get_user_by( &#039;login&#039;, sanitize_user( wp_unslash( $_GET[&#039;login&#039;] ) ) ); // phpcs:ignore WordPress.Security.NonceVerification.Recommended
				$user_id = $user ? $user-&gt;ID : 0;
			} else {
				$user_id = absint( $_GET[&#039;id&#039;] ); // phpcs:ignore WordPress.Security.NonceVerification.Recommended
			}

			// If the reset token is not for the current user, ignore the reset request (don&#039;t redirect).
			$logged_in_user_id = get_current_user_id();
			if ( $logged_in_user_id &amp;&amp; $logged_in_user_id !== $user_id ) {
				wc_add_notice( __( &#039;This password reset key is for a different user account. Please log out and try again.&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
				return;
			}

			$action = isset( $_GET[&#039;action&#039;] ) ? sanitize_text_field( wp_unslash( $_GET[&#039;action&#039;] ) ) : &#039;&#039;;
			$value   = sprintf( &#039;%d:%s&#039;, $user_id, wp_unslash( $_GET[&#039;key&#039;] ) ); // phpcs:ignore
			WC_Shortcode_My_Account::set_reset_password_cookie( $value );
			wp_safe_redirect(
				add_query_arg(
					array(
						&#039;show-reset-form&#039; =&gt; &#039;true&#039;,
						&#039;action&#039;          =&gt; $action,
					),
					wc_lostpassword_url()
				)
			);
			exit;
		}
	}

	/**
	 * Save and and update a billing or shipping address if the
	 * form was submitted through the user account page.
	 */
	public static function save_address() {
		global $wp;

		$nonce_value = wc_get_var( $_REQUEST[&#039;woocommerce-edit-address-nonce&#039;], wc_get_var( $_REQUEST[&#039;_wpnonce&#039;], &#039;&#039; ) ); // @codingStandardsIgnoreLine.

		if ( ! wp_verify_nonce( $nonce_value, &#039;woocommerce-edit_address&#039; ) ) {
			return;
		}

		if ( empty( $_POST[&#039;action&#039;] ) || &#039;edit_address&#039; !== $_POST[&#039;action&#039;] ) {
			return;
		}

		wc_nocache_headers();

		$user_id = get_current_user_id();

		if ( $user_id &lt;= 0 ) {
			return;
		}

		$customer = new WC_Customer( $user_id );

		if ( ! $customer ) {
			return;
		}

		$load_address = isset( $wp-&gt;query_vars[&#039;edit-address&#039;] ) ? wc_edit_address_i18n( sanitize_title( $wp-&gt;query_vars[&#039;edit-address&#039;] ), true ) : &#039;billing&#039;;

		if ( ! isset( $_POST[ $load_address . &#039;_country&#039; ] ) ) {
			return;
		}

		$address = WC()-&gt;countries-&gt;get_address_fields( wc_clean( wp_unslash( $_POST[ $load_address . &#039;_country&#039; ] ) ), $load_address . &#039;_&#039; );

		foreach ( $address as $key =&gt; $field ) {
			if ( ! isset( $field[&#039;type&#039;] ) ) {
				$field[&#039;type&#039;] = &#039;text&#039;;
			}

			// Get Value.
			if ( &#039;checkbox&#039; === $field[&#039;type&#039;] ) {
				$value = (int) isset( $_POST[ $key ] );
			} else {
				$value = isset( $_POST[ $key ] ) ? wc_clean( wp_unslash( $_POST[ $key ] ) ) : &#039;&#039;;
			}

			// Hook to allow modification of value.
			$value = apply_filters( &#039;woocommerce_process_myaccount_field_&#039; . $key, $value );

			// Validation: Required fields.
			if ( ! empty( $field[&#039;required&#039;] ) &amp;&amp; empty( $value ) ) {
				/* translators: %s: Field name. */
				wc_add_notice( sprintf( __( &#039;%s is a required field.&#039;, &#039;woocommerce&#039; ), $field[&#039;label&#039;] ), &#039;error&#039;, array( &#039;id&#039; =&gt; $key ) );
			}

			if ( ! empty( $value ) ) {
				// Validation and formatting rules.
				if ( ! empty( $field[&#039;validate&#039;] ) &amp;&amp; is_array( $field[&#039;validate&#039;] ) ) {
					foreach ( $field[&#039;validate&#039;] as $rule ) {
						switch ( $rule ) {
							case &#039;postcode&#039;:
								$country = wc_clean( wp_unslash( $_POST[ $load_address . &#039;_country&#039; ] ) );
								$value   = wc_format_postcode( $value, $country );

								if ( &#039;&#039; !== $value &amp;&amp; ! WC_Validation::is_postcode( $value, $country ) ) {
									switch ( $country ) {
										case &#039;IE&#039;:
											$postcode_validation_notice = __( &#039;Please enter a valid Eircode.&#039;, &#039;woocommerce&#039; );
											break;
										default:
											$postcode_validation_notice = __( &#039;Please enter a valid postcode / ZIP.&#039;, &#039;woocommerce&#039; );
									}
									wc_add_notice( $postcode_validation_notice, &#039;error&#039; );
								}
								break;
							case &#039;phone&#039;:
								if ( &#039;&#039; !== $value &amp;&amp; ! WC_Validation::is_phone( $value ) ) {
									/* translators: %s: Phone number. */
									wc_add_notice( sprintf( __( &#039;%s is not a valid phone number.&#039;, &#039;woocommerce&#039; ), &#039;&lt;strong&gt;&#039; . $field[&#039;label&#039;] . &#039;&lt;/strong&gt;&#039; ), &#039;error&#039; );
								}
								break;
							case &#039;email&#039;:
								$value = strtolower( $value );

								if ( ! is_email( $value ) ) {
									/* translators: %s: Email address. */
									wc_add_notice( sprintf( __( &#039;%s is not a valid email address.&#039;, &#039;woocommerce&#039; ), &#039;&lt;strong&gt;&#039; . $field[&#039;label&#039;] . &#039;&lt;/strong&gt;&#039; ), &#039;error&#039; );
								}
								break;
						}
					}
				}
			}

			try {
				// Set prop in customer object.
				if ( is_callable( array( $customer, &quot;set_$key&quot; ) ) ) {
					$customer-&gt;{&quot;set_$key&quot;}( $value );
				} else {
					$customer-&gt;update_meta_data( $key, $value );
				}
			} catch ( WC_Data_Exception $e ) {
				// Set notices. Ignore invalid billing email, since is already validated.
				if ( &#039;customer_invalid_billing_email&#039; !== $e-&gt;getErrorCode() ) {
					wc_add_notice( $e-&gt;getMessage(), &#039;error&#039; );
				}
			}
		}

		/**
		 * Hook: woocommerce_after_save_address_validation.
		 *
		 * Allow developers to add custom validation logic and throw an error to prevent save.
		 *
		 * @param int         $user_id User ID being saved.
		 * @param string      $load_address Type of address e.g. billing or shipping.
		 * @param array       $address The address fields.
		 * @param WC_Customer $customer The customer object being saved. @since 3.6.0
		 */
		do_action( &#039;woocommerce_after_save_address_validation&#039;, $user_id, $load_address, $address, $customer );

		if ( 0 &lt; wc_notice_count( &#039;error&#039; ) ) {
			return;
		}

		$customer-&gt;save();

		wc_add_notice( __( &#039;Address changed successfully.&#039;, &#039;woocommerce&#039; ) );

		do_action( &#039;woocommerce_customer_save_address&#039;, $user_id, $load_address );

		wp_safe_redirect( wc_get_endpoint_url( &#039;edit-address&#039;, &#039;&#039;, wc_get_page_permalink( &#039;myaccount&#039; ) ) );
		exit;
	}

	/**
	 * Save the password/account details and redirect back to the my account page.
	 */
	public static function save_account_details() {
		$nonce_value = wc_get_var( $_REQUEST[&#039;save-account-details-nonce&#039;], wc_get_var( $_REQUEST[&#039;_wpnonce&#039;], &#039;&#039; ) ); // @codingStandardsIgnoreLine.

		if ( ! wp_verify_nonce( $nonce_value, &#039;save_account_details&#039; ) ) {
			return;
		}

		if ( empty( $_POST[&#039;action&#039;] ) || &#039;save_account_details&#039; !== $_POST[&#039;action&#039;] ) {
			return;
		}

		wc_nocache_headers();

		$user_id = get_current_user_id();

		if ( $user_id &lt;= 0 ) {
			return;
		}

		$account_first_name   = ! empty( $_POST[&#039;account_first_name&#039;] ) ? wc_clean( wp_unslash( $_POST[&#039;account_first_name&#039;] ) ) : &#039;&#039;;
		$account_last_name    = ! empty( $_POST[&#039;account_last_name&#039;] ) ? wc_clean( wp_unslash( $_POST[&#039;account_last_name&#039;] ) ) : &#039;&#039;;
		$account_display_name = ! empty( $_POST[&#039;account_display_name&#039;] ) ? wc_clean( wp_unslash( $_POST[&#039;account_display_name&#039;] ) ) : &#039;&#039;;
		$account_email        = ! empty( $_POST[&#039;account_email&#039;] ) ? wc_clean( wp_unslash( $_POST[&#039;account_email&#039;] ) ) : &#039;&#039;;
		$pass_cur             = ! empty( $_POST[&#039;password_current&#039;] ) ? $_POST[&#039;password_current&#039;] : &#039;&#039;; // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized, WordPress.Security.ValidatedSanitizedInput.MissingUnslash
		$pass1                = ! empty( $_POST[&#039;password_1&#039;] ) ? $_POST[&#039;password_1&#039;] : &#039;&#039;; // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized, WordPress.Security.ValidatedSanitizedInput.MissingUnslash
		$pass2                = ! empty( $_POST[&#039;password_2&#039;] ) ? $_POST[&#039;password_2&#039;] : &#039;&#039;; // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized, WordPress.Security.ValidatedSanitizedInput.MissingUnslash
		$save_pass            = true;

		// Current user data.
		$current_user       = get_user_by( &#039;id&#039;, $user_id );
		$current_first_name = $current_user-&gt;first_name;
		$current_last_name  = $current_user-&gt;last_name;
		$current_email      = $current_user-&gt;user_email;

		// New user data.
		$user               = new stdClass();
		$user-&gt;ID           = $user_id;
		$user-&gt;first_name   = $account_first_name;
		$user-&gt;last_name    = $account_last_name;
		$user-&gt;display_name = $account_display_name;

		// Prevent display name to be changed to email.
		if ( is_email( $account_display_name ) ) {
			wc_add_notice( __( &#039;Display name cannot be changed to email address due to privacy concern.&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
		}

		// Handle required fields.
		$required_fields = apply_filters(
			&#039;woocommerce_save_account_details_required_fields&#039;,
			array(
				&#039;account_first_name&#039;   =&gt; __( &#039;First name&#039;, &#039;woocommerce&#039; ),
				&#039;account_last_name&#039;    =&gt; __( &#039;Last name&#039;, &#039;woocommerce&#039; ),
				&#039;account_display_name&#039; =&gt; __( &#039;Display name&#039;, &#039;woocommerce&#039; ),
				&#039;account_email&#039;        =&gt; __( &#039;Email address&#039;, &#039;woocommerce&#039; ),
			)
		);

		foreach ( $required_fields as $field_key =&gt; $field_name ) {
			if ( empty( $_POST[ $field_key ] ) ) {
				/* translators: %s: Field name. */
				wc_add_notice( sprintf( __( &#039;%s is a required field.&#039;, &#039;woocommerce&#039; ), &#039;&lt;strong&gt;&#039; . esc_html( $field_name ) . &#039;&lt;/strong&gt;&#039; ), &#039;error&#039;, array( &#039;id&#039; =&gt; $field_key ) );
			}
		}

		if ( $account_email ) {
			$account_email = sanitize_email( $account_email );
			if ( ! is_email( $account_email ) ) {
				wc_add_notice( __( &#039;Please provide a valid email address.&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
			} elseif ( email_exists( $account_email ) &amp;&amp; $account_email !== $current_user-&gt;user_email ) {
				wc_add_notice( __( &#039;This email address is already registered.&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
			}
			$user-&gt;user_email = $account_email;
		}

		if ( ! empty( $pass_cur ) &amp;&amp; empty( $pass1 ) &amp;&amp; empty( $pass2 ) ) {
			wc_add_notice( __( &#039;Please fill out all password fields.&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
			$save_pass = false;
		} elseif ( ! empty( $pass1 ) &amp;&amp; empty( $pass_cur ) ) {
			wc_add_notice( __( &#039;Please enter your current password.&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
			$save_pass = false;
		} elseif ( ! empty( $pass1 ) &amp;&amp; empty( $pass2 ) ) {
			wc_add_notice( __( &#039;Please re-enter your password.&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
			$save_pass = false;
		} elseif ( ( ! empty( $pass1 ) || ! empty( $pass2 ) ) &amp;&amp; $pass1 !== $pass2 ) {
			wc_add_notice( __( &#039;New passwords do not match.&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
			$save_pass = false;
		} elseif ( ! empty( $pass1 ) &amp;&amp; ! wp_check_password( $pass_cur, $current_user-&gt;user_pass, $current_user-&gt;ID ) ) {
			wc_add_notice( __( &#039;Your current password is incorrect.&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
			$save_pass = false;
		}

		if ( $pass1 &amp;&amp; $save_pass ) {
			$user-&gt;user_pass = $pass1;
		}

		// Allow plugins to return their own errors.
		$errors = new WP_Error();
		do_action_ref_array( &#039;woocommerce_save_account_details_errors&#039;, array( &amp;$errors, &amp;$user ) );

		if ( $errors-&gt;get_error_messages() ) {
			foreach ( $errors-&gt;get_error_messages() as $error ) {
				wc_add_notice( $error, &#039;error&#039; );
			}
		}

		if ( wc_notice_count( &#039;error&#039; ) === 0 ) {
			wp_update_user( $user );

			// Update customer object to keep data in sync.
			$customer = new WC_Customer( $user-&gt;ID );

			if ( $customer ) {
				// Keep billing data in sync if data changed.
				if ( is_email( $user-&gt;user_email ) &amp;&amp; $current_email !== $user-&gt;user_email ) {
					$customer-&gt;set_billing_email( $user-&gt;user_email );
				}

				if ( $current_first_name !== $user-&gt;first_name ) {
					$customer-&gt;set_billing_first_name( $user-&gt;first_name );
				}

				if ( $current_last_name !== $user-&gt;last_name ) {
					$customer-&gt;set_billing_last_name( $user-&gt;last_name );
				}

				$customer-&gt;save();
			}

			wc_add_notice( __( &#039;Account details changed successfully.&#039;, &#039;woocommerce&#039; ) );

			do_action( &#039;woocommerce_save_account_details&#039;, $user-&gt;ID );

			wp_safe_redirect( wc_get_page_permalink( &#039;myaccount&#039; ) );
			exit;
		}
	}

	/**
	 * Process the checkout form.
	 */
	public static function checkout_action() {
		if ( isset( $_POST[&#039;woocommerce_checkout_place_order&#039;] ) || isset( $_POST[&#039;woocommerce_checkout_update_totals&#039;] ) ) { // phpcs:ignore WordPress.Security.NonceVerification.Missing
			wc_nocache_headers();

			if ( WC()-&gt;cart-&gt;is_empty() ) {
				wp_safe_redirect( wc_get_cart_url() );
				exit;
			}

			wc_maybe_define_constant( &#039;WOOCOMMERCE_CHECKOUT&#039;, true );

			WC()-&gt;checkout()-&gt;process_checkout();
		}
	}

	/**
	 * Process the pay form.
	 *
	 * @throws Exception On payment error.
	 */
	public static function pay_action() {
		global $wp;

		if ( isset( $_POST[&#039;woocommerce_pay&#039;], $_GET[&#039;key&#039;] ) ) {
			wc_nocache_headers();

			$nonce_value = wc_get_var( $_REQUEST[&#039;woocommerce-pay-nonce&#039;], wc_get_var( $_REQUEST[&#039;_wpnonce&#039;], &#039;&#039; ) ); // @codingStandardsIgnoreLine.

			if ( ! wp_verify_nonce( $nonce_value, &#039;woocommerce-pay&#039; ) ) {
				return;
			}

			ob_start();

			// Pay for existing order.
			$order_key = wp_unslash( $_GET[&#039;key&#039;] ); // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
			$order_id  = absint( $wp-&gt;query_vars[&#039;order-pay&#039;] );
			$order     = wc_get_order( $order_id );

			if ( $order_id === $order-&gt;get_id() &amp;&amp; hash_equals( $order-&gt;get_order_key(), $order_key ) &amp;&amp; $order-&gt;needs_payment() ) {

				do_action( &#039;woocommerce_before_pay_action&#039;, $order );

				WC()-&gt;customer-&gt;set_props(
					array(
						&#039;billing_country&#039;  =&gt; $order-&gt;get_billing_country() ? $order-&gt;get_billing_country() : null,
						&#039;billing_state&#039;    =&gt; $order-&gt;get_billing_state() ? $order-&gt;get_billing_state() : null,
						&#039;billing_postcode&#039; =&gt; $order-&gt;get_billing_postcode() ? $order-&gt;get_billing_postcode() : null,
						&#039;billing_city&#039;     =&gt; $order-&gt;get_billing_city() ? $order-&gt;get_billing_city() : null,
					)
				);
				WC()-&gt;customer-&gt;save();

				if ( ! empty( $_POST[&#039;terms-field&#039;] ) &amp;&amp; empty( $_POST[&#039;terms&#039;] ) ) {
					wc_add_notice( __( &#039;Please read and accept the terms and conditions to proceed with your order.&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
					return;
				}

				// Update payment method.
				if ( $order-&gt;needs_payment() ) {
					try {
						$payment_method_id = isset( $_POST[&#039;payment_method&#039;] ) ? wc_clean( wp_unslash( $_POST[&#039;payment_method&#039;] ) ) : false;

						if ( ! $payment_method_id ) {
							throw new Exception( __( &#039;Invalid payment method.&#039;, &#039;woocommerce&#039; ) );
						}

						$available_gateways = WC()-&gt;payment_gateways-&gt;get_available_payment_gateways();
						$payment_method     = isset( $available_gateways[ $payment_method_id ] ) ? $available_gateways[ $payment_method_id ] : false;

						if ( ! $payment_method ) {
							throw new Exception( __( &#039;Invalid payment method.&#039;, &#039;woocommerce&#039; ) );
						}

						$order-&gt;set_payment_method( $payment_method );
						$order-&gt;save();

						$payment_method-&gt;validate_fields();

						if ( 0 === wc_notice_count( &#039;error&#039; ) ) {

							$result = $payment_method-&gt;process_payment( $order_id );

							// Redirect to success/confirmation/payment page.
							if ( isset( $result[&#039;result&#039;] ) &amp;&amp; &#039;success&#039; === $result[&#039;result&#039;] ) {
								$result[&#039;order_id&#039;] = $order_id;

								$result = apply_filters( &#039;woocommerce_payment_successful_result&#039;, $result, $order_id );

								wp_redirect( $result[&#039;redirect&#039;] ); //phpcs:ignore WordPress.Security.SafeRedirect.wp_redirect_wp_redirect
								exit;
							}
						}
					} catch ( Exception $e ) {
						wc_add_notice( $e-&gt;getMessage(), &#039;error&#039; );
					}
				} else {
					// No payment was required for order.
					$order-&gt;payment_complete();
					wp_safe_redirect( $order-&gt;get_checkout_order_received_url() );
					exit;
				}

				do_action( &#039;woocommerce_after_pay_action&#039;, $order );

			}
		}
	}

	/**
	 * Process the add payment method form.
	 */
	public static function add_payment_method_action() {
		if ( isset( $_POST[&#039;woocommerce_add_payment_method&#039;], $_POST[&#039;payment_method&#039;] ) ) {
			wc_nocache_headers();

			$nonce_value = wc_get_var( $_REQUEST[&#039;woocommerce-add-payment-method-nonce&#039;], wc_get_var( $_REQUEST[&#039;_wpnonce&#039;], &#039;&#039; ) ); // @codingStandardsIgnoreLine.

			if ( ! wp_verify_nonce( $nonce_value, &#039;woocommerce-add-payment-method&#039; ) ) {
				return;
			}

			if ( ! apply_filters( &#039;woocommerce_add_payment_method_form_is_valid&#039;, true ) ) {
				return;
			}

			// Test rate limit.
			$current_user_id = get_current_user_id();
			$rate_limit_id   = &#039;add_payment_method_&#039; . $current_user_id;
			$delay           = (int) apply_filters( &#039;woocommerce_payment_gateway_add_payment_method_delay&#039;, 20 );

			if ( WC_Rate_Limiter::retried_too_soon( $rate_limit_id ) ) {
				wc_add_notice(
					sprintf(
						/* translators: %d number of seconds */
						_n(
							&#039;You cannot add a new payment method so soon after the previous one. Please wait for %d second.&#039;,
							&#039;You cannot add a new payment method so soon after the previous one. Please wait for %d seconds.&#039;,
							$delay,
							&#039;woocommerce&#039;
						),
						$delay
					),
					&#039;error&#039;
				);
				return;
			}

			WC_Rate_Limiter::set_rate_limit( $rate_limit_id, $delay );

			ob_start();

			$payment_method_id  = wc_clean( wp_unslash( $_POST[&#039;payment_method&#039;] ) );
			$available_gateways = WC()-&gt;payment_gateways-&gt;get_available_payment_gateways();

			if ( isset( $available_gateways[ $payment_method_id ] ) ) {
				$gateway = $available_gateways[ $payment_method_id ];

				if ( ! $gateway-&gt;supports( &#039;add_payment_method&#039; ) &amp;&amp; ! $gateway-&gt;supports( &#039;tokenization&#039; ) ) {
					wc_add_notice( __( &#039;Invalid payment gateway.&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
					return;
				}

				$gateway-&gt;validate_fields();

				if ( wc_notice_count( &#039;error&#039; ) &gt; 0 ) {
					return;
				}

				$result = $gateway-&gt;add_payment_method();

				if ( &#039;success&#039; === $result[&#039;result&#039;] ) {
					wc_add_notice( __( &#039;Payment method successfully added.&#039;, &#039;woocommerce&#039; ) );
				}

				if ( &#039;failure&#039; === $result[&#039;result&#039;] ) {
					wc_add_notice( __( &#039;Unable to add payment method to your account.&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
				}

				if ( ! empty( $result[&#039;redirect&#039;] ) ) {
					wp_redirect( $result[&#039;redirect&#039;] ); //phpcs:ignore WordPress.Security.SafeRedirect.wp_redirect_wp_redirect
					exit();
				}
			}
		}
	}

	/**
	 * Process the delete payment method form.
	 */
	public static function delete_payment_method_action() {
		global $wp;

		if ( isset( $wp-&gt;query_vars[&#039;delete-payment-method&#039;] ) ) {
			wc_nocache_headers();

			$token_id = absint( $wp-&gt;query_vars[&#039;delete-payment-method&#039;] );
			$token    = WC_Payment_Tokens::get( $token_id );

			if ( is_null( $token ) || get_current_user_id() !== $token-&gt;get_user_id() || ! isset( $_REQUEST[&#039;_wpnonce&#039;] ) || false === wp_verify_nonce( wp_unslash( $_REQUEST[&#039;_wpnonce&#039;] ), &#039;delete-payment-method-&#039; . $token_id ) ) { // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
				wc_add_notice( __( &#039;Invalid payment method.&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
			} else {
				WC_Payment_Tokens::delete( $token_id );
				wc_add_notice( __( &#039;Payment method deleted.&#039;, &#039;woocommerce&#039; ) );
			}

			wp_safe_redirect( wc_get_account_endpoint_url( &#039;payment-methods&#039; ) );
			exit();
		}

	}

	/**
	 * Process the delete payment method form.
	 */
	public static function set_default_payment_method_action() {
		global $wp;

		if ( isset( $wp-&gt;query_vars[&#039;set-default-payment-method&#039;] ) ) {
			wc_nocache_headers();

			$token_id = absint( $wp-&gt;query_vars[&#039;set-default-payment-method&#039;] );
			$token    = WC_Payment_Tokens::get( $token_id );

			if ( is_null( $token ) || get_current_user_id() !== $token-&gt;get_user_id() || ! isset( $_REQUEST[&#039;_wpnonce&#039;] ) || false === wp_verify_nonce( wp_unslash( $_REQUEST[&#039;_wpnonce&#039;] ), &#039;set-default-payment-method-&#039; . $token_id ) ) { // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
				wc_add_notice( __( &#039;Invalid payment method.&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
			} else {
				WC_Payment_Tokens::set_users_default( $token-&gt;get_user_id(), intval( $token_id ) );
				wc_add_notice( __( &#039;This payment method was successfully set as your default.&#039;, &#039;woocommerce&#039; ) );
			}

			wp_safe_redirect( wc_get_account_endpoint_url( &#039;payment-methods&#039; ) );
			exit();
		}

	}

	/**
	 * Remove from cart/update.
	 */
	public static function update_cart_action() {
		if ( ! ( isset( $_REQUEST[&#039;apply_coupon&#039;] ) || isset( $_REQUEST[&#039;remove_coupon&#039;] ) || isset( $_REQUEST[&#039;remove_item&#039;] ) || isset( $_REQUEST[&#039;undo_item&#039;] ) || isset( $_REQUEST[&#039;update_cart&#039;] ) || isset( $_REQUEST[&#039;proceed&#039;] ) ) ) {
			return;
		}

		wc_nocache_headers();

		$nonce_value = wc_get_var( $_REQUEST[&#039;woocommerce-cart-nonce&#039;], wc_get_var( $_REQUEST[&#039;_wpnonce&#039;], &#039;&#039; ) ); // @codingStandardsIgnoreLine.

		if ( ! empty( $_POST[&#039;apply_coupon&#039;] ) &amp;&amp; ! empty( $_POST[&#039;coupon_code&#039;] ) ) {
			WC()-&gt;cart-&gt;add_discount( wc_format_coupon_code( wp_unslash( $_POST[&#039;coupon_code&#039;] ) ) ); // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized

		} elseif ( isset( $_GET[&#039;remove_coupon&#039;] ) ) {
			WC()-&gt;cart-&gt;remove_coupon( wc_format_coupon_code( urldecode( wp_unslash( $_GET[&#039;remove_coupon&#039;] ) ) ) ); // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized

		} elseif ( ! empty( $_GET[&#039;remove_item&#039;] ) &amp;&amp; wp_verify_nonce( $nonce_value, &#039;woocommerce-cart&#039; ) ) {
			$cart_item_key = sanitize_text_field( wp_unslash( $_GET[&#039;remove_item&#039;] ) );
			$cart_item     = WC()-&gt;cart-&gt;get_cart_item( $cart_item_key );

			if ( $cart_item ) {
				WC()-&gt;cart-&gt;remove_cart_item( $cart_item_key );

				$product = wc_get_product( $cart_item[&#039;product_id&#039;] );

				/* translators: %s: Item name. */
				$item_removed_title = apply_filters( &#039;woocommerce_cart_item_removed_title&#039;, $product ? sprintf( _x( &#039;&amp;ldquo;%s&amp;rdquo;&#039;, &#039;Item name in quotes&#039;, &#039;woocommerce&#039; ), $product-&gt;get_name() ) : __( &#039;Item&#039;, &#039;woocommerce&#039; ), $cart_item );

				// Don&#039;t show undo link if removed item is out of stock.
				if ( $product &amp;&amp; $product-&gt;is_in_stock() &amp;&amp; $product-&gt;has_enough_stock( $cart_item[&#039;quantity&#039;] ) ) {
					/* Translators: %s Product title. */
					$removed_notice  = sprintf( __( &#039;%s removed.&#039;, &#039;woocommerce&#039; ), $item_removed_title );
					$removed_notice .= &#039; &lt;a href=&quot;&#039; . esc_url( wc_get_cart_undo_url( $cart_item_key ) ) . &#039;&quot; class=&quot;restore-item&quot;&gt;&#039; . __( &#039;Undo?&#039;, &#039;woocommerce&#039; ) . &#039;&lt;/a&gt;&#039;;
				} else {
					/* Translators: %s Product title. */
					$removed_notice = sprintf( __( &#039;%s removed.&#039;, &#039;woocommerce&#039; ), $item_removed_title );
				}

				wc_add_notice( $removed_notice, apply_filters( &#039;woocommerce_cart_item_removed_notice_type&#039;, &#039;success&#039; ) );
			}

			$referer = wp_get_referer() ? remove_query_arg( array( &#039;remove_item&#039;, &#039;add-to-cart&#039;, &#039;added-to-cart&#039;, &#039;order_again&#039;, &#039;_wpnonce&#039; ), add_query_arg( &#039;removed_item&#039;, &#039;1&#039;, wp_get_referer() ) ) : wc_get_cart_url();
			wp_safe_redirect( $referer );
			exit;

		} elseif ( ! empty( $_GET[&#039;undo_item&#039;] ) &amp;&amp; isset( $_GET[&#039;_wpnonce&#039;] ) &amp;&amp; wp_verify_nonce( $nonce_value, &#039;woocommerce-cart&#039; ) ) {

			// Undo Cart Item.
			$cart_item_key = sanitize_text_field( wp_unslash( $_GET[&#039;undo_item&#039;] ) );

			WC()-&gt;cart-&gt;restore_cart_item( $cart_item_key );

			$referer = wp_get_referer() ? remove_query_arg( array( &#039;undo_item&#039;, &#039;_wpnonce&#039; ), wp_get_referer() ) : wc_get_cart_url();
			wp_safe_redirect( $referer );
			exit;

		}

		// Update Cart - checks apply_coupon too because they are in the same form.
		if ( ( ! empty( $_POST[&#039;apply_coupon&#039;] ) || ! empty( $_POST[&#039;update_cart&#039;] ) || ! empty( $_POST[&#039;proceed&#039;] ) ) &amp;&amp; wp_verify_nonce( $nonce_value, &#039;woocommerce-cart&#039; ) ) {

			$cart_updated = false;
			$cart_totals  = isset( $_POST[&#039;cart&#039;] ) ? wp_unslash( $_POST[&#039;cart&#039;] ) : &#039;&#039;; // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized

			if ( ! WC()-&gt;cart-&gt;is_empty() &amp;&amp; is_array( $cart_totals ) ) {
				foreach ( WC()-&gt;cart-&gt;get_cart() as $cart_item_key =&gt; $values ) {

					$_product = $values[&#039;data&#039;];

					// Skip product if no updated quantity was posted.
					if ( ! isset( $cart_totals[ $cart_item_key ] ) || ! isset( $cart_totals[ $cart_item_key ][&#039;qty&#039;] ) ) {
						continue;
					}

					// Sanitize.
					$quantity = apply_filters( &#039;woocommerce_stock_amount_cart_item&#039;, wc_stock_amount( preg_replace( &#039;/[^0-9\.]/&#039;, &#039;&#039;, $cart_totals[ $cart_item_key ][&#039;qty&#039;] ) ), $cart_item_key );

					if ( &#039;&#039; === $quantity || $quantity === $values[&#039;quantity&#039;] ) {
						continue;
					}

					// Update cart validation.
					$passed_validation = apply_filters( &#039;woocommerce_update_cart_validation&#039;, true, $cart_item_key, $values, $quantity );

					// is_sold_individually.
					if ( $_product-&gt;is_sold_individually() &amp;&amp; $quantity &gt; 1 ) {
						/* Translators: %s Product title. */
						wc_add_notice( sprintf( __( &#039;You can only have 1 %s in your cart.&#039;, &#039;woocommerce&#039; ), $_product-&gt;get_name() ), &#039;error&#039; );
						$passed_validation = false;
					}

					if ( $passed_validation ) {
						WC()-&gt;cart-&gt;set_quantity( $cart_item_key, $quantity, false );
						$cart_updated = true;
					}
				}
			}

			// Trigger action - let 3rd parties update the cart if they need to and update the $cart_updated variable.
			$cart_updated = apply_filters( &#039;woocommerce_update_cart_action_cart_updated&#039;, $cart_updated );

			if ( $cart_updated ) {
				WC()-&gt;cart-&gt;calculate_totals();
			}

			if ( ! empty( $_POST[&#039;proceed&#039;] ) ) {
				wp_safe_redirect( wc_get_checkout_url() );
				exit;
			} elseif ( $cart_updated ) {
				wc_add_notice( __( &#039;Cart updated.&#039;, &#039;woocommerce&#039; ), apply_filters( &#039;woocommerce_cart_updated_notice_type&#039;, &#039;success&#039; ) );
				$referer = remove_query_arg( array( &#039;remove_coupon&#039;, &#039;add-to-cart&#039; ), ( wp_get_referer() ? wp_get_referer() : wc_get_cart_url() ) );
				wp_safe_redirect( $referer );
				exit;
			}
		}
	}

	/**
	 * Place a previous order again.
	 *
	 * @deprecated 3.5.0 Logic moved to cart session handling.
	 */
	public static function order_again() {
		wc_deprecated_function( &#039;WC_Form_Handler::order_again&#039;, &#039;3.5&#039;, &#039;This method should not be called manually.&#039; );
	}

	/**
	 * Cancel a pending order.
	 */
	public static function cancel_order() {
		if (
			isset( $_GET[&#039;cancel_order&#039;] ) &amp;&amp;
			isset( $_GET[&#039;order&#039;] ) &amp;&amp;
			isset( $_GET[&#039;order_id&#039;] ) &amp;&amp;
			( isset( $_GET[&#039;_wpnonce&#039;] ) &amp;&amp; wp_verify_nonce( wp_unslash( $_GET[&#039;_wpnonce&#039;] ), &#039;woocommerce-cancel_order&#039; ) ) // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
		) {
			wc_nocache_headers();

			$order_key        = wp_unslash( $_GET[&#039;order&#039;] ); // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
			$order_id         = absint( $_GET[&#039;order_id&#039;] );
			$order            = wc_get_order( $order_id );
			$user_can_cancel  = current_user_can( &#039;cancel_order&#039;, $order_id );
			$order_can_cancel = $order-&gt;has_status( apply_filters( &#039;woocommerce_valid_order_statuses_for_cancel&#039;, array( &#039;pending&#039;, &#039;failed&#039; ), $order ) );
			$redirect         = isset( $_GET[&#039;redirect&#039;] ) ? wp_unslash( $_GET[&#039;redirect&#039;] ) : &#039;&#039;; // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized

			if ( $user_can_cancel &amp;&amp; $order_can_cancel &amp;&amp; $order-&gt;get_id() === $order_id &amp;&amp; hash_equals( $order-&gt;get_order_key(), $order_key ) ) {

				// Cancel the order + restore stock.
				WC()-&gt;session-&gt;set( &#039;order_awaiting_payment&#039;, false );
				$order-&gt;update_status( &#039;cancelled&#039;, __( &#039;Order cancelled by customer.&#039;, &#039;woocommerce&#039; ) );

				wc_add_notice( apply_filters( &#039;woocommerce_order_cancelled_notice&#039;, __( &#039;Your order was cancelled.&#039;, &#039;woocommerce&#039; ) ), apply_filters( &#039;woocommerce_order_cancelled_notice_type&#039;, &#039;notice&#039; ) );

				do_action( &#039;woocommerce_cancelled_order&#039;, $order-&gt;get_id() );

			} elseif ( $user_can_cancel &amp;&amp; ! $order_can_cancel ) {
				wc_add_notice( __( &#039;Your order can no longer be cancelled. Please contact us if you need assistance.&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
			} else {
				wc_add_notice( __( &#039;Invalid order.&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
			}

			if ( $redirect ) {
				wp_safe_redirect( $redirect );
				exit;
			}
		}
	}

	/**
	 * Add to cart action.
	 *
	 * Checks for a valid request, does validation (via hooks) and then redirects if valid.
	 *
	 * @param bool $url (default: false) URL to redirect to.
	 */
	public static function add_to_cart_action( $url = false ) {
		if ( ! isset( $_REQUEST[&#039;add-to-cart&#039;] ) || ! is_numeric( wp_unslash( $_REQUEST[&#039;add-to-cart&#039;] ) ) ) { // phpcs:ignore WordPress.Security.NonceVerification.Recommended, WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
			return;
		}

		wc_nocache_headers();

		$product_id        = apply_filters( &#039;woocommerce_add_to_cart_product_id&#039;, absint( wp_unslash( $_REQUEST[&#039;add-to-cart&#039;] ) ) ); // phpcs:ignore WordPress.Security.NonceVerification.Recommended
		$was_added_to_cart = false;
		$adding_to_cart    = wc_get_product( $product_id );

		if ( ! $adding_to_cart ) {
			return;
		}

		$add_to_cart_handler = apply_filters( &#039;woocommerce_add_to_cart_handler&#039;, $adding_to_cart-&gt;get_type(), $adding_to_cart );

		if ( &#039;variable&#039; === $add_to_cart_handler || &#039;variation&#039; === $add_to_cart_handler ) {
			$was_added_to_cart = self::add_to_cart_handler_variable( $product_id );
		} elseif ( &#039;grouped&#039; === $add_to_cart_handler ) {
			$was_added_to_cart = self::add_to_cart_handler_grouped( $product_id );
		} elseif ( has_action( &#039;woocommerce_add_to_cart_handler_&#039; . $add_to_cart_handler ) ) {
			do_action( &#039;woocommerce_add_to_cart_handler_&#039; . $add_to_cart_handler, $url ); // Custom handler.
		} else {
			$was_added_to_cart = self::add_to_cart_handler_simple( $product_id );
		}

		// If we added the product to the cart we can now optionally do a redirect.
		if ( $was_added_to_cart &amp;&amp; 0 === wc_notice_count( &#039;error&#039; ) ) {
			$url = apply_filters( &#039;woocommerce_add_to_cart_redirect&#039;, $url, $adding_to_cart );

			if ( $url ) {
				wp_safe_redirect( $url );
				exit;
			} elseif ( &#039;yes&#039; === get_option( &#039;woocommerce_cart_redirect_after_add&#039; ) ) {
				wp_safe_redirect( wc_get_cart_url() );
				exit;
			}
		}
	}

	/**
	 * Handle adding simple products to the cart.
	 *
	 * @since 2.4.6 Split from add_to_cart_action.
	 * @param int $product_id Product ID to add to the cart.
	 * @return bool success or not
	 */
	private static function add_to_cart_handler_simple( $product_id ) {
		$quantity          = empty( $_REQUEST[&#039;quantity&#039;] ) ? 1 : wc_stock_amount( wp_unslash( $_REQUEST[&#039;quantity&#039;] ) ); // phpcs:ignore WordPress.Security.NonceVerification.Recommended
		$passed_validation = apply_filters( &#039;woocommerce_add_to_cart_validation&#039;, true, $product_id, $quantity );

		if ( $passed_validation &amp;&amp; false !== WC()-&gt;cart-&gt;add_to_cart( $product_id, $quantity ) ) {
			wc_add_to_cart_message( array( $product_id =&gt; $quantity ), true );
			return true;
		}
		return false;
	}

	/**
	 * Handle adding grouped products to the cart.
	 *
	 * @since 2.4.6 Split from add_to_cart_action.
	 * @param int $product_id Product ID to add to the cart.
	 * @return bool success or not
	 */
	private static function add_to_cart_handler_grouped( $product_id ) {
		$was_added_to_cart = false;
		$added_to_cart     = array();
		$items             = isset( $_REQUEST[&#039;quantity&#039;] ) &amp;&amp; is_array( $_REQUEST[&#039;quantity&#039;] ) ? wp_unslash( $_REQUEST[&#039;quantity&#039;] ) : array(); // phpcs:ignore WordPress.Security.NonceVerification.Recommended, WordPress.Security.ValidatedSanitizedInput.InputNotSanitized

		if ( ! empty( $items ) ) {
			$quantity_set = false;

			foreach ( $items as $item =&gt; $quantity ) {
				$quantity = wc_stock_amount( $quantity );
				if ( $quantity &lt;= 0 ) {
					continue;
				}
				$quantity_set = true;

				// Add to cart validation.
				$passed_validation = apply_filters( &#039;woocommerce_add_to_cart_validation&#039;, true, $item, $quantity );

				// Suppress total recalculation until finished.
				remove_action( &#039;woocommerce_add_to_cart&#039;, array( WC()-&gt;cart, &#039;calculate_totals&#039; ), 20, 0 );

				if ( $passed_validation &amp;&amp; false !== WC()-&gt;cart-&gt;add_to_cart( $item, $quantity ) ) {
					$was_added_to_cart      = true;
					$added_to_cart[ $item ] = $quantity;
				}

				add_action( &#039;woocommerce_add_to_cart&#039;, array( WC()-&gt;cart, &#039;calculate_totals&#039; ), 20, 0 );
			}

			if ( ! $was_added_to_cart &amp;&amp; ! $quantity_set ) {
				wc_add_notice( __( &#039;Please choose the quantity of items you wish to add to your cart&amp;hellip;&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
			} elseif ( $was_added_to_cart ) {
				wc_add_to_cart_message( $added_to_cart );
				WC()-&gt;cart-&gt;calculate_totals();
				return true;
			}
		} elseif ( $product_id ) {
			/* Link on product archives */
			wc_add_notice( __( &#039;Please choose a product to add to your cart&amp;hellip;&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
		}
		return false;
	}

	/**
	 * Handle adding variable products to the cart.
	 *
	 * @since 2.4.6 Split from add_to_cart_action.
	 * @throws Exception If add to cart fails.
	 * @param int $product_id Product ID to add to the cart.
	 * @return bool success or not
	 */
	private static function add_to_cart_handler_variable( $product_id ) {
		$variation_id = empty( $_REQUEST[&#039;variation_id&#039;] ) ? &#039;&#039; : absint( wp_unslash( $_REQUEST[&#039;variation_id&#039;] ) );  // phpcs:ignore WordPress.Security.NonceVerification.Recommended
		$quantity     = empty( $_REQUEST[&#039;quantity&#039;] ) ? 1 : wc_stock_amount( wp_unslash( $_REQUEST[&#039;quantity&#039;] ) );  // phpcs:ignore WordPress.Security.NonceVerification.Recommended
		$variations   = array();

		$product      = wc_get_product( $product_id );

		foreach ( $_REQUEST as $key =&gt; $value ) { // phpcs:ignore WordPress.Security.NonceVerification.Recommended
			if ( &#039;attribute_&#039; !== substr( $key, 0, 10 ) ) {
				continue;
			}

			$variations[ sanitize_title( wp_unslash( $key ) ) ] = wp_unslash( $value );
		}

		$passed_validation = apply_filters( &#039;woocommerce_add_to_cart_validation&#039;, true, $product_id, $quantity, $variation_id, $variations );

		if ( ! $passed_validation ) {
			return false;
		}

		// Prevent parent variable product from being added to cart.
		if ( empty( $variation_id ) &amp;&amp; $product &amp;&amp; $product-&gt;is_type( &#039;variable&#039; ) ) {
			/* translators: 1: product link, 2: product name */
			wc_add_notice( sprintf( __( &#039;Please choose product options by visiting &lt;a href=&quot;%1$s&quot; title=&quot;%2$s&quot;&gt;%2$s&lt;/a&gt;.&#039;, &#039;woocommerce&#039; ), esc_url( get_permalink( $product_id ) ), esc_html( $product-&gt;get_name() ) ), &#039;error&#039; );

			return false;
		}

		if ( false !== WC()-&gt;cart-&gt;add_to_cart( $product_id, $quantity, $variation_id, $variations ) ) {
			wc_add_to_cart_message( array( $product_id =&gt; $quantity ), true );
			return true;
		}

		return false;
	}

	/**
	 * Process the login form.
	 *
	 * @throws Exception On login error.
	 */
	public static function process_login() {
		// The global form-login.php template used `_wpnonce` in template versions &lt; 3.3.0.
		$nonce_value = wc_get_var( $_REQUEST[&#039;woocommerce-login-nonce&#039;], wc_get_var( $_REQUEST[&#039;_wpnonce&#039;], &#039;&#039; ) ); // @codingStandardsIgnoreLine.

		if ( isset( $_POST[&#039;login&#039;], $_POST[&#039;username&#039;], $_POST[&#039;password&#039;] ) &amp;&amp; wp_verify_nonce( $nonce_value, &#039;woocommerce-login&#039; ) ) {

			try {
				$creds = array(
					&#039;user_login&#039;    =&gt; trim( wp_unslash( $_POST[&#039;username&#039;] ) ), // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
					&#039;user_password&#039; =&gt; $_POST[&#039;password&#039;], // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized, WordPress.Security.ValidatedSanitizedInput.MissingUnslash
					&#039;remember&#039;      =&gt; isset( $_POST[&#039;rememberme&#039;] ), // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
				);

				$validation_error = new WP_Error();
				$validation_error = apply_filters( &#039;woocommerce_process_login_errors&#039;, $validation_error, $creds[&#039;user_login&#039;], $creds[&#039;user_password&#039;] );

				if ( $validation_error-&gt;get_error_code() ) {
					throw new Exception( &#039;&lt;strong&gt;&#039; . __( &#039;Error:&#039;, &#039;woocommerce&#039; ) . &#039;&lt;/strong&gt; &#039; . $validation_error-&gt;get_error_message() );
				}

				if ( empty( $creds[&#039;user_login&#039;] ) ) {
					throw new Exception( &#039;&lt;strong&gt;&#039; . __( &#039;Error:&#039;, &#039;woocommerce&#039; ) . &#039;&lt;/strong&gt; &#039; . __( &#039;Username is required.&#039;, &#039;woocommerce&#039; ) );
				}

				// On multisite, ensure user exists on current site, if not add them before allowing login.
				if ( is_multisite() ) {
					$user_data = get_user_by( is_email( $creds[&#039;user_login&#039;] ) ? &#039;email&#039; : &#039;login&#039;, $creds[&#039;user_login&#039;] );

					if ( $user_data &amp;&amp; ! is_user_member_of_blog( $user_data-&gt;ID, get_current_blog_id() ) ) {
						add_user_to_blog( get_current_blog_id(), $user_data-&gt;ID, &#039;customer&#039; );
					}
				}

				// Perform the login.
				$user = wp_signon( apply_filters( &#039;woocommerce_login_credentials&#039;, $creds ), is_ssl() );

				if ( is_wp_error( $user ) ) {
					throw new Exception( $user-&gt;get_error_message() );
				} else {

					if ( ! empty( $_POST[&#039;redirect&#039;] ) ) {
						$redirect = wp_unslash( $_POST[&#039;redirect&#039;] ); // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
					} elseif ( wc_get_raw_referer() ) {
						$redirect = wc_get_raw_referer();
					} else {
						$redirect = wc_get_page_permalink( &#039;myaccount&#039; );
					}

					wp_redirect( wp_validate_redirect( apply_filters( &#039;woocommerce_login_redirect&#039;, remove_query_arg( &#039;wc_error&#039;, $redirect ), $user ), wc_get_page_permalink( &#039;myaccount&#039; ) ) ); // phpcs:ignore
					exit;
				}
			} catch ( Exception $e ) {
				wc_add_notice( apply_filters( &#039;login_errors&#039;, $e-&gt;getMessage() ), &#039;error&#039; );
				do_action( &#039;woocommerce_login_failed&#039; );
			}
		}
	}

	/**
	 * Handle lost password form.
	 */
	public static function process_lost_password() {
		if ( isset( $_POST[&#039;wc_reset_password&#039;], $_POST[&#039;user_login&#039;] ) ) {
			$nonce_value = wc_get_var( $_REQUEST[&#039;woocommerce-lost-password-nonce&#039;], wc_get_var( $_REQUEST[&#039;_wpnonce&#039;], &#039;&#039; ) ); // @codingStandardsIgnoreLine.

			if ( ! wp_verify_nonce( $nonce_value, &#039;lost_password&#039; ) ) {
				return;
			}

			$success = WC_Shortcode_My_Account::retrieve_password();

			// If successful, redirect to my account with query arg set.
			if ( $success ) {
				wp_safe_redirect( add_query_arg( &#039;reset-link-sent&#039;, &#039;true&#039;, wc_get_account_endpoint_url( &#039;lost-password&#039; ) ) );
				exit;
			}
		}
	}

	/**
	 * Handle reset password form.
	 */
	public static function process_reset_password() {
		$nonce_value = wc_get_var( $_REQUEST[&#039;woocommerce-reset-password-nonce&#039;], wc_get_var( $_REQUEST[&#039;_wpnonce&#039;], &#039;&#039; ) ); // @codingStandardsIgnoreLine.

		if ( ! wp_verify_nonce( $nonce_value, &#039;reset_password&#039; ) ) {
			return;
		}

		$posted_fields = array( &#039;wc_reset_password&#039;, &#039;password_1&#039;, &#039;password_2&#039;, &#039;reset_key&#039;, &#039;reset_login&#039; );

		foreach ( $posted_fields as $field ) {
			if ( ! isset( $_POST[ $field ] ) ) {
				return;
			}

			if ( in_array( $field, array( &#039;password_1&#039;, &#039;password_2&#039; ), true ) ) {
				// Don&#039;t unslash password fields
				// @see https://github.com/woocommerce/woocommerce/issues/23922.
				$posted_fields[ $field ] = $_POST[ $field ]; // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized, WordPress.Security.ValidatedSanitizedInput.MissingUnslash
			} else {
				$posted_fields[ $field ] = wp_unslash( $_POST[ $field ] ); // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
			}
		}

		$user = WC_Shortcode_My_Account::check_password_reset_key( $posted_fields[&#039;reset_key&#039;], $posted_fields[&#039;reset_login&#039;] );

		if ( $user instanceof WP_User ) {
			if ( empty( $posted_fields[&#039;password_1&#039;] ) ) {
				wc_add_notice( __( &#039;Please enter your password.&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
			}

			if ( $posted_fields[&#039;password_1&#039;] !== $posted_fields[&#039;password_2&#039;] ) {
				wc_add_notice( __( &#039;Passwords do not match.&#039;, &#039;woocommerce&#039; ), &#039;error&#039; );
			}

			$errors = new WP_Error();

			do_action( &#039;validate_password_reset&#039;, $errors, $user );

			wc_add_wp_error_notices( $errors );

			if ( 0 === wc_notice_count( &#039;error&#039; ) ) {
				WC_Shortcode_My_Account::reset_password( $user, $posted_fields[&#039;password_1&#039;] );

				do_action( &#039;woocommerce_customer_reset_password&#039;, $user );

				wp_safe_redirect( add_query_arg( &#039;password-reset&#039;, &#039;true&#039;, wc_get_page_permalink( &#039;myaccount&#039; ) ) );
				exit;
			}
		}
	}

	/**
	 * Process the registration form.
	 *
	 * @throws Exception On registration error.
	 */
	public static function process_registration() {
		$nonce_value = isset( $_POST[&#039;_wpnonce&#039;] ) ? wp_unslash( $_POST[&#039;_wpnonce&#039;] ) : &#039;&#039;; // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
		$nonce_value = isset( $_POST[&#039;woocommerce-register-nonce&#039;] ) ? wp_unslash( $_POST[&#039;woocommerce-register-nonce&#039;] ) : $nonce_value; // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized

		if ( isset( $_POST[&#039;register&#039;], $_POST[&#039;email&#039;] ) &amp;&amp; wp_verify_nonce( $nonce_value, &#039;woocommerce-register&#039; ) ) {
			$username = &#039;no&#039; === get_option( &#039;woocommerce_registration_generate_username&#039; ) &amp;&amp; isset( $_POST[&#039;username&#039;] ) ? wp_unslash( $_POST[&#039;username&#039;] ) : &#039;&#039;; // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
			$password = &#039;no&#039; === get_option( &#039;woocommerce_registration_generate_password&#039; ) &amp;&amp; isset( $_POST[&#039;password&#039;] ) ? $_POST[&#039;password&#039;] : &#039;&#039;; // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized, WordPress.Security.ValidatedSanitizedInput.MissingUnslash
			$email    = wp_unslash( $_POST[&#039;email&#039;] ); // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized

			try {
				$validation_error  = new WP_Error();
				$validation_error  = apply_filters( &#039;woocommerce_process_registration_errors&#039;, $validation_error, $username, $password, $email );
				$validation_errors = $validation_error-&gt;get_error_messages();

				if ( 1 === count( $validation_errors ) ) {
					throw new Exception( $validation_error-&gt;get_error_message() );
				} elseif ( $validation_errors ) {
					foreach ( $validation_errors as $message ) {
						wc_add_notice( &#039;&lt;strong&gt;&#039; . __( &#039;Error:&#039;, &#039;woocommerce&#039; ) . &#039;&lt;/strong&gt; &#039; . $message, &#039;error&#039; );
					}
					throw new Exception();
				}

				$new_customer = wc_create_new_customer( sanitize_email( $email ), wc_clean( $username ), $password );

				if ( is_wp_error( $new_customer ) ) {
					throw new Exception( $new_customer-&gt;get_error_message() );
				}

				if ( &#039;yes&#039; === get_option( &#039;woocommerce_registration_generate_password&#039; ) ) {
					wc_add_notice( __( &#039;Your account was created successfully and a password has been sent to your email address.&#039;, &#039;woocommerce&#039; ) );
				} else {
					wc_add_notice( __( &#039;Your account was created successfully. Your login details have been sent to your email address.&#039;, &#039;woocommerce&#039; ) );
				}

				// Only redirect after a forced login - otherwise output a success notice.
				if ( apply_filters( &#039;woocommerce_registration_auth_new_customer&#039;, true, $new_customer ) ) {
					wc_set_customer_auth_cookie( $new_customer );

					if ( ! empty( $_POST[&#039;redirect&#039;] ) ) {
						$redirect = wp_sanitize_redirect( wp_unslash( $_POST[&#039;redirect&#039;] ) ); // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
					} elseif ( wc_get_raw_referer() ) {
						$redirect = wc_get_raw_referer();
					} else {
						$redirect = wc_get_page_permalink( &#039;myaccount&#039; );
					}

					wp_redirect( wp_validate_redirect( apply_filters( &#039;woocommerce_registration_redirect&#039;, $redirect ), wc_get_page_permalink( &#039;myaccount&#039; ) ) ); //phpcs:ignore WordPress.Security.SafeRedirect.wp_redirect_wp_redirect
					exit;
				}
			} catch ( Exception $e ) {
				if ( $e-&gt;getMessage() ) {
					wc_add_notice( &#039;&lt;strong&gt;&#039; . __( &#039;Error:&#039;, &#039;woocommerce&#039; ) . &#039;&lt;/strong&gt; &#039; . $e-&gt;getMessage(), &#039;error&#039; );
				}
			}
		}
	}
}

WC_Form_Handler::init();
</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>WooCommerce Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on July 12th, 2021 at 10:33 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1626085994"></script>
    <script src="../js/search.js?updated=1626085994"></script>
</body>
</html>
